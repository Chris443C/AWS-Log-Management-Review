<!--
Speedtest Dashboard - Modern Enriched Version
Features:
- Interactive Chart.js chart (download/upload/ping, zoom/pan, anomaly markers)
- Summary stats (avg/min/max/count)
- Date range picker
- CSV/JSON export
- Responsive design
- Outage highlighting
- Tooltips with all data fields
- All data from results.csv
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#1976d2">
  
  <!-- Favicon and icons -->
  <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-192x192.png">
  <link rel="icon" type="image/png" sizes="16x16" href="icons/icon-192x192.png">
  <link rel="shortcut icon" href="icons/icon-192x192.png">
  <link rel="apple-touch-icon" href="icons/icon-192x192.png">
  <link rel="apple-touch-icon" sizes="192x192" href="icons/icon-192x192.png">
  <link rel="apple-touch-icon" sizes="512x512" href="icons/icon-512x512.png">
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">
  
  <title>Speedtest Dashboard</title>
  <!-- Remove external CDN dependencies that cause CSP issues -->
  <style>
    /* Basic flatpickr styles inline to avoid CSP issues */
    .flatpickr-calendar { 
      display: none; 
      position: absolute; 
      z-index: 9999; 
      background: var(--container-bg); 
      border: 1px solid var(--border); 
      border-radius: 8px; 
      padding: 1rem; 
    }
    .flatpickr-calendar.open { display: block; }
  </style>
  <style>
    :root {
      --bg: #f8fafc;
      --container-bg: #ffffff;
      --text: #1e293b;
      --text-secondary: #64748b;
      --primary: #3b82f6;
      --primary-dark: #2563eb;
      --secondary: #64748b;
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
      --card-bg: #f1f5f9;
      --card-bg2: #e2e8f0;
      --table-bg: #ffffff;
      --table-row: #f8fafc;
      --table-hover: #e2e8f0;
      --hover-bg: #f1f5f9;
      --chart-bg: #ffffff;
      --border: #e2e8f0;
      --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    }
    .dark-mode {
      --bg: #0f172a;
      --container-bg: #1e293b;
      --text: #f1f5f9;
      --text-secondary: #94a3b8;
      --primary: #60a5fa;
      --primary-dark: #3b82f6;
      --secondary: #94a3b8;
      --success: #34d399;
      --warning: #fbbf24;
      --error: #f87171;
      --card-bg: #334155;
      --card-bg2: #475569;
      --table-bg: #1e293b;
      --table-row: #334155;
      --table-hover: #475569;
      --hover-bg: #334155;
      --chart-bg: #1e293b;
      --border: #475569;
      --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.3), 0 1px 2px -1px rgb(0 0 0 / 0.3);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.3), 0 4px 6px -4px rgb(0 0 0 / 0.3);
    }
    
    * { box-sizing: border-box; }
    
    body { 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
      margin: 0; 
      background: linear-gradient(135deg, var(--bg) 0%, var(--container-bg) 100%); 
      color: var(--text); 
      transition: background 0.3s cubic-bezier(0.4, 0, 0.2, 1), color 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      line-height: 1.6;
    }
    
    .container { 
      max-width: 1200px; 
      margin: 20px auto; 
      background: var(--container-bg); 
      border-radius: 16px; 
      box-shadow: var(--shadow-lg); 
      padding: 32px; 
      border: 1px solid var(--border);
      transition: all 0.3s ease;
    }
    
    h1 { 
      color: var(--primary); 
      margin-bottom: 0.5em; 
      letter-spacing: -0.025em; 
      font-size: 2.5rem; 
      font-weight: 700;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .summary { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
      gap: 1.5rem; 
      margin: 2rem 0; 
    }
    
    .summary-card { 
      background: linear-gradient(135deg, var(--card-bg) 0%, var(--card-bg2) 100%); 
      border-radius: 12px; 
      padding: 1.5rem; 
      box-shadow: var(--shadow); 
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: 1px solid var(--border);
      position: relative;
      overflow: hidden;
    }
    
    .summary-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--primary), var(--success));
      transform: scaleX(0);
      transition: transform 0.3s ease;
    }
    
    .summary-card:hover { 
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
    
    .summary-card:hover::before {
      transform: scaleX(1);
    }
    
    .summary-card b { 
      font-size: 1.25rem; 
      color: var(--primary); 
      font-weight: 600;
      display: block;
      margin-bottom: 0.5rem;
    }

    /* Latest Speed Cards Styling */
    .latest-speed {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%) !important;
      color: white !important;
      border: 2px solid rgba(255, 255, 255, 0.2);
      position: relative;
      overflow: hidden;
    }

    .latest-speed::before {
      background: linear-gradient(90deg, rgba(255,255,255,0.1), rgba(255,255,255,0.3), rgba(255,255,255,0.1)) !important;
    }

    .latest-speed b {
      color: rgba(255, 255, 255, 0.9) !important;
      font-size: 1rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 0.75rem;
    }

    .latest-value {
      font-size: 2rem;
      font-weight: 700;
      color: white;
      line-height: 1;
      margin-bottom: 0.5rem;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .latest-time {
      font-size: 0.85rem;
      color: rgba(255, 255, 255, 0.8);
      font-weight: 500;
      opacity: 0.9;
    }

    .latest-speed:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(25, 118, 210, 0.4);
    }
    
    .controls { 
      display: flex; 
      flex-wrap: wrap; 
      gap: 1rem; 
      align-items: center; 
      margin-bottom: 2rem;
      padding: 1.5rem;
      background: var(--card-bg);
      border-radius: 12px;
      border: 1px solid var(--border);
    }
    
    .controls label { 
      font-weight: 500; 
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .export-btn { 
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); 
      color: white; 
      border: none; 
      border-radius: 8px; 
      padding: 0.75rem 1.5rem; 
      cursor: pointer; 
      font-weight: 500; 
      box-shadow: var(--shadow); 
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    
    .export-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }
    
    .export-btn:hover { 
      transform: translateY(-1px);
      box-shadow: var(--shadow-lg);
    }
    
    .export-btn:hover::before {
      left: 100%;
    }
    
    .export-btn:active {
      transform: translateY(0);
    }
    
    .outage { 
      color: var(--error); 
      font-weight: 600; 
      margin-top: 1rem;
      padding: 1rem;
      background: rgba(239, 68, 68, 0.1);
      border-radius: 8px;
      border: 1px solid rgba(239, 68, 68, 0.2);
    }
    
    #speedChart { 
      background: var(--chart-bg); 
      border-radius: 12px; 
      box-shadow: var(--shadow); 
      margin-bottom: 2rem;
      border: 1px solid var(--border);
      transition: all 0.3s ease;
      width: 100% !important;
      height: 400px !important;
      max-height: 400px !important;
    }
    
    table { 
      border-collapse: collapse; 
      background: var(--table-bg); 
      border-radius: 12px; 
      overflow: hidden;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      width: 100%;
    }
    
    th, td { 
      padding: 1rem; 
      text-align: left; 
      border-bottom: 1px solid var(--border);
    }
    
    th { 
      background: var(--card-bg2); 
      color: var(--primary); 
      font-weight: 600; 
      cursor: pointer; 
      user-select: none; 
      transition: all 0.3s ease;
      position: relative;
    }
    
    th:hover { 
      background: var(--primary); 
      color: white; 
      transform: translateY(-1px);
    }
    
    th.sortable::after { 
      content: ' ↕'; 
      opacity: 0.5; 
      transition: opacity 0.3s ease;
    }
    
    th.sort-asc::after { 
      content: ' ↑'; 
      opacity: 1; 
    }
    
    th.sort-desc::after { 
      content: ' ↓'; 
      opacity: 1; 
    }
    
    tr:nth-child(even) { 
      background: var(--table-row); 
    }
    
    tr:hover { 
      background: var(--table-hover); 
      transform: scale(1.01);
      transition: all 0.2s ease;
    }
    
    .status-bar { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin: 1.5rem 0; 
      padding: 1rem 1.5rem; 
      background: var(--card-bg); 
      border-radius: 12px; 
      font-size: 0.9rem;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
    }
    
    .last-updated { 
      color: var(--primary); 
      font-weight: 500; 
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    /* Enhanced Hover Effects */
    .primary-btn, .secondary-btn, .group-toggle {
      position: relative;
      overflow: hidden;
    }

    .primary-btn::before, .secondary-btn::before, .group-toggle::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s;
    }

    .primary-btn:hover::before, .secondary-btn:hover::before, .group-toggle:hover::before {
      left: 100%;
    }

    /* Loading Animation */
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }

    .primary-btn:disabled .btn-icon {
      animation: pulse 1.5s infinite;
    }
    
    .data-freshness { 
      display: flex; 
      align-items: center; 
      gap: 0.75rem; 
    }
    
    .freshness-indicator { 
      width: 10px; 
      height: 10px; 
      border-radius: 50%; 
      box-shadow: 0 0 0 2px rgba(255,255,255,0.2);
    }
    
    .freshness-fresh { 
      background: var(--success);
      box-shadow: 0 0 10px var(--success);
    }
    
    .freshness-stale { 
      background: var(--warning);
      box-shadow: 0 0 10px var(--warning);
    }
    
    .freshness-old { 
      background: var(--error);
      box-shadow: 0 0 10px var(--error);
    }
    
    .loading { 
      display: inline-block; 
      width: 20px; 
      height: 20px; 
      border: 2px solid var(--primary); 
      border-radius: 50%; 
      border-top-color: transparent; 
      animation: spin 1s linear infinite; 
    }
    
    @keyframes spin { 
      to { transform: rotate(360deg); } 
    }
    
    .error-message { 
      background: rgba(239, 68, 68, 0.1); 
      color: var(--error); 
      padding: 1rem 1.5rem; 
      border-radius: 8px; 
      margin: 1rem 0; 
      border: 1px solid rgba(239, 68, 68, 0.2);
      animation: slideIn 0.3s ease;
    }
    
    .success-message { 
      background: rgba(16, 185, 129, 0.1); 
      color: var(--success); 
      padding: 1rem 1.5rem; 
      border-radius: 8px; 
      margin: 1rem 0; 
      border: 1px solid rgba(16, 185, 129, 0.2);
      animation: slideIn 0.3s ease;
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .keyboard-shortcuts { 
      position: fixed; 
      bottom: 20px; 
      right: 20px; 
      background: var(--container-bg); 
      padding: 1.5rem; 
      border-radius: 12px; 
      box-shadow: var(--shadow-lg); 
      font-size: 0.85rem; 
      display: none; 
      z-index: 1000;
      border: 1px solid var(--border);
      animation: slideIn 0.3s ease;
    }
    
    .keyboard-shortcuts.show { 
      display: block; 
    }
    
    kbd {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 0.25rem 0.5rem;
      font-size: 0.8rem;
      font-family: monospace;
      box-shadow: var(--shadow);
    }
    
    /* Skeleton Loading */
    .skeleton {
      background: linear-gradient(90deg, var(--card-bg) 25%, var(--card-bg2) 50%, var(--card-bg) 75%);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
      border-radius: 4px;
    }
    
    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    
    .skeleton-card {
      height: 120px;
      margin-bottom: 1rem;
    }
    
    .skeleton-text {
      height: 1rem;
      margin-bottom: 0.5rem;
    }
    
    .skeleton-text:last-child {
      width: 60%;
    }
    
    /* Dashboard Sections */
    /* Enhanced Main Controls */
    .main-controls {
      background: var(--section-bg);
      border-radius: 16px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }

    .primary-actions {
      display: flex;
      align-items: center;
      gap: 1.5rem;
      margin-bottom: 1.5rem;
      padding-bottom: 1.5rem;
      border-bottom: 1px solid var(--border);
    }

    .primary-btn {
      background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
      color: white;
      border: none;
      padding: 1rem 2rem;
      border-radius: 12px;
      font-size: 1.1rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
      min-height: 56px;
    }

    .primary-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
    }

    .primary-btn:disabled {
      background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
      cursor: not-allowed;
      box-shadow: 0 4px 12px rgba(255, 152, 0, 0.3);
    }

    .btn-icon {
      font-size: 1.2rem;
    }

    .btn-text {
      font-weight: 600;
    }

    .test-status-display {
      padding: 0.75rem 1.25rem;
      background: var(--container-bg);
      border: 2px solid var(--border);
      border-radius: 12px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .filter-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: flex-end;
      margin-bottom: 1.5rem;
      padding-bottom: 1.5rem;
      border-bottom: 1px solid var(--border);
    }

    .control-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      min-width: 140px;
    }

    .control-label {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .control-input,
    .control-select {
      padding: 0.75rem 1rem;
      border: 2px solid var(--border);
      border-radius: 8px;
      background: var(--container-bg);
      color: var(--text);
      font-size: 0.95rem;
      transition: all 0.3s ease;
    }

    .control-input:focus,
    .control-select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.1);
    }

    .checkbox-group {
      align-self: center;
      margin-top: 1rem;
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      cursor: pointer;
      font-weight: 500;
    }

    .control-checkbox {
      width: 18px;
      height: 18px;
      accent-color: var(--primary);
    }

    .secondary-btn {
      background: var(--container-bg);
      color: var(--text);
      border: 2px solid var(--border);
      padding: 0.75rem 1.25rem;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 500;
      transition: all 0.3s ease;
      align-self: flex-end;
    }

    .secondary-btn:hover {
      background: var(--hover-bg);
      border-color: var(--primary);
    }

    .action-groups {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .btn-group {
      position: relative;
    }

    .group-toggle {
      background: var(--container-bg);
      color: var(--text);
      border: 2px solid var(--border);
      padding: 0.75rem 1.25rem;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-weight: 500;
      transition: all 0.3s ease;
      min-width: 120px;
    }

    .group-toggle:hover {
      background: var(--hover-bg);
      border-color: var(--primary);
    }

    .group-arrow {
      margin-left: auto;
      transition: transform 0.3s ease;
      font-size: 0.8rem;
    }

    .btn-group.active .group-arrow {
      transform: rotate(180deg);
    }

    .group-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--section-bg);
      border: 2px solid var(--border);
      border-radius: 8px;
      box-shadow: var(--shadow-lg);
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
      transition: all 0.3s ease;
      margin-top: 0.5rem;
    }

    .btn-group.active .group-dropdown {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .dropdown-btn {
      width: 100%;
      background: transparent;
      color: var(--text);
      border: none;
      padding: 0.75rem 1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      transition: background-color 0.2s ease;
      font-size: 0.95rem;
    }

    .dropdown-btn:hover {
      background: var(--hover-bg);
    }

    .dropdown-btn:first-child {
      border-radius: 6px 6px 0 0;
    }

    .dropdown-btn:last-child {
      border-radius: 0 0 6px 6px;
    }

    .dashboard-section {
      margin-bottom: 2rem;
      animation: fadeInUp 0.6s ease;
      background: var(--section-bg);
      border-radius: 12px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      overflow: hidden;
    }
    
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid var(--border);
    }
    
    .section-title {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--primary);
    }
    
    .section-toggle {
      background: none;
      border: none;
      color: var(--secondary);
      cursor: pointer;
      padding: 0.5rem;
      border-radius: 4px;
      transition: all 0.3s ease;
    }
    
    .section-toggle:hover {
      background: var(--card-bg);
      color: var(--primary);
    }
    
    .section-content {
      transition: all 0.3s ease;
    }
    
    .section-hidden .section-content {
      display: none;
    }
    
    /* Chart Enhancements */
    .chart-container {
      position: relative;
      padding: 1rem;
      border-radius: 12px;
      background: var(--chart-bg);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      width: 100%;
      height: 450px;
      overflow: hidden;
    }
    
    .chart-controls {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    
    .chart-type-btn {
      background: var(--card-bg);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.9rem;
    }
    
    .chart-type-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    .chart-type-btn:hover {
      background: var(--primary);
      color: white;
      transform: translateY(-1px);
    }
    
    .chart-view-controls {
      display: flex;
      gap: 0.25rem;
      margin-left: 1rem;
    }
    
    .chart-view-btn {
      background: var(--container-bg);
      color: var(--text);
      border: 2px solid var(--border);
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    
    .chart-view-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    .chart-view-btn:hover:not(.active) {
      background: var(--hover-bg);
      border-color: var(--primary);
    }
    
    .chart-navigation {
      margin-left: 1rem;
      padding: 0.25rem 0.75rem;
      background: var(--card-bg);
      border-radius: 8px;
      border: 1px solid var(--border);
    }
    
    .nav-btn {
      background: var(--container-bg);
      color: var(--text);
      border: 1px solid var(--border);
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: bold;
      transition: all 0.3s ease;
      min-width: 30px;
    }
    
    .nav-btn:hover {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    .nav-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .nav-btn:disabled:hover {
      background: var(--container-bg);
      color: var(--text);
      border-color: var(--border);
    }
    
    .date-range-display {
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--text-secondary);
      min-width: 100px;
      text-align: center;
    }
    
    .date-range-inputs {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .date-input {
      flex: 1;
      min-width: 140px;
    }
    
    .date-separator {
      color: var(--text-secondary);
      font-weight: 500;
      white-space: nowrap;
    }
    
    /* Mobile Responsiveness */
    @media (max-width: 768px) {
      .container { 
        margin: 10px; 
        padding: 20px;
      }
      
      h1 {
        font-size: 2rem;
      }
      
      .summary { 
        grid-template-columns: 1fr; 
        gap: 1rem; 
      }
      
      .controls { 
        flex-direction: column; 
        gap: 1rem;
        align-items: stretch;
      }
      
      .export-btn {
        width: 100%;
        text-align: center;
      }
      
      th, td { 
        font-size: 0.9rem; 
        padding: 0.75rem 0.5rem;
      }
      
      .status-bar { 
        flex-direction: column; 
        gap: 1rem; 
        text-align: center; 
      }
      
      .chart-controls {
        justify-content: center;
        flex-direction: column;
        gap: 0.5rem;
      }
      
      .chart-view-controls {
        margin-left: 0;
        justify-content: center;
      }
      
      .chart-navigation {
        margin-left: 0;
        justify-content: center;
      }
      
      .date-range-inputs {
        flex-direction: column;
        gap: 0.25rem;
      }
      
      .date-input {
        min-width: auto;
        width: 100%;
      }
      
      .date-separator {
        display: none;
      }
      
      .chart-type-btn {
        flex: 1;
        min-height: 44px;
        font-size: 0.85rem;
        padding: 0.75rem 0.5rem;
      }
      
      .keyboard-shortcuts {
        bottom: 10px;
        right: 10px;
        left: 10px;
        position: fixed;
      }
      
      /* Mobile table scrolling */
      .table-container {
        overflow-x: auto;
        border-radius: 12px;
        box-shadow: var(--shadow);
      }
      
      table {
        min-width: 800px;
      }
      
      /* Mobile chart optimizations */
      .chart-container {
        padding: 0.5rem;
        margin: 0 -0.5rem;
      }
      
      #speedChart {
        max-height: 300px !important;
        height: 300px !important;
      }
      
      /* Mobile section optimizations */
      .section-title {
        font-size: 1.25rem;
      }
      
      .section-header {
        flex-direction: column;
        gap: 0.5rem;
        align-items: flex-start;
      }

      /* Mobile Controls */
      .main-controls {
        padding: 1rem;
      }

      .primary-actions {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
      }

      .primary-btn {
        width: 100%;
        justify-content: center;
        min-height: 64px;
        font-size: 1.2rem;
      }

      .test-status-display {
        width: 100%;
        justify-content: center;
      }

      .filter-controls {
        flex-direction: column;
        gap: 1rem;
      }

      .control-group {
        min-width: 100%;
      }

      .action-groups {
        flex-direction: column;
        gap: 0.5rem;
      }

      .group-toggle {
        width: 100%;
        justify-content: space-between;
        min-height: 48px;
      }

      /* Mobile latest speed cards */
      .latest-value {
        font-size: 1.75rem;
      }

      .latest-speed b {
        font-size: 0.9rem;
      }
      
      /* Mobile comparison cards */
      .comparison-cards {
        grid-template-columns: 1fr;
        gap: 1rem;
      }
      
      /* Mobile health score */
      .health-score-value {
        font-size: 2.5rem;
      }
      
      .health-metrics {
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
      }
      
      /* Mobile quick actions */
      .quick-actions {
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
      }
      
      /* Mobile export options */
      .export-options {
        grid-template-columns: 1fr;
        gap: 0.75rem;
      }
      
      /* Mobile time analysis */
      .time-analysis-header {
        flex-direction: column;
        gap: 0.75rem;
        align-items: flex-start;
      }
      
      .time-analysis-controls {
        width: 100%;
        justify-content: space-between;
      }
      
      .time-period-btn {
        flex: 1;
        min-height: 44px;
        font-size: 0.8rem;
        padding: 0.5rem 0.25rem;
      }
      
      /* Mobile heatmap */
      .heatmap-grid {
        min-width: 600px;
        gap: 1px;
      }
      
      .heatmap-cell {
        min-width: 20px;
        min-height: 20px;
      }
    }
    
    /* Small mobile devices */
    @media (max-width: 480px) {
      .container {
        margin: 5px;
        padding: 15px;
      }
      
      h1 {
        font-size: 1.75rem;
      }
      
      .chart-controls {
        gap: 0.25rem;
      }
      
      .chart-type-btn {
        font-size: 0.8rem;
        padding: 0.5rem 0.25rem;
      }
      
      #speedChart {
        max-height: 250px !important;
        height: 250px !important;
      }
      
      .health-score-value {
        font-size: 2rem;
      }
      
      .health-metrics {
        grid-template-columns: 1fr;
      }
      
      .quick-actions {
        grid-template-columns: 1fr;
      }
      
      .comparison-cards {
        gap: 0.75rem;
      }
      
      .comparison-card {
        padding: 1rem;
      }
      
      .comparison-metric {
        padding: 0.25rem;
        font-size: 0.9rem;
      }
    }
    
    /* Touch optimizations */
    @media (hover: none) and (pointer: coarse) {
      .export-btn {
        min-height: 44px;
      }
      
      th, td {
        min-height: 44px;
      }
      
      .chart-type-btn {
        min-height: 44px;
        min-width: 44px;
      }
      
      /* Enhanced touch targets for chart controls */
      .chart-controls button {
        min-height: 44px;
        min-width: 44px;
        touch-action: manipulation;
      }
      
      /* Improve chart touch interaction */
      #speedChart {
        touch-action: pan-x pinch-zoom;
      }
      
      /* Better touch feedback */
      .chart-type-btn:active,
      .export-btn:active {
        transform: scale(0.95);
      }
    }
    
    .flatpickr-calendar { display: none !important; }
    .flatpickr-calendar.open { display: block !important; z-index: 9999 !important; }
    
    /* Anomaly Detection */
    .anomaly-row {
      background: rgba(239, 68, 68, 0.1) !important;
      border-left: 4px solid var(--error);
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.8; }
    }
    
    .anomaly-row:hover {
      background: rgba(239, 68, 68, 0.2) !important;
    }
    
    /* Enhanced Chart Tooltips */
    .chart-tooltip {
      background: var(--container-bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      box-shadow: var(--shadow-lg);
      font-size: 0.9rem;
      max-width: 300px;
    }
    
    .chart-tooltip .metric {
      display: flex;
      justify-content: space-between;
      margin-bottom: 0.5rem;
    }
    
    .chart-tooltip .metric-label {
      font-weight: 600;
      color: var(--primary);
    }
    
    .chart-tooltip .metric-value {
      color: var(--text);
    }
    
    .chart-tooltip .anomaly-warning {
      color: var(--error);
      font-weight: 600;
      margin-top: 0.5rem;
      padding: 0.5rem;
      background: rgba(239, 68, 68, 0.1);
      border-radius: 4px;
      border: 1px solid rgba(239, 68, 68, 0.2);
    }
    
    /* ISP Comparison Styles */
    .comparison-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-top: 1rem;
    }
    
    .comparison-card {
      background: linear-gradient(135deg, var(--card-bg) 0%, var(--card-bg2) 100%);
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    
    .comparison-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary), var(--success));
      transform: scaleX(0);
      transition: transform 0.3s ease;
    }
    
    .comparison-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
    
    .comparison-card:hover::before {
      transform: scaleX(1);
    }
    
    .comparison-card h3 {
      margin: 0 0 1rem 0;
      color: var(--primary);
      font-size: 1.25rem;
      font-weight: 600;
    }
    
    .comparison-metric {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
      padding: 0.5rem;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 6px;
      border: 1px solid var(--border);
    }
    
    .metric-label {
      font-weight: 500;
      color: var(--text);
    }
    
    .metric-value {
      font-weight: 600;
      color: var(--primary);
    }
    
    .metric-comparison {
      font-size: 0.85rem;
      color: var(--secondary);
      margin-left: 0.5rem;
    }
    
    .ranking-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
      text-align: center;
      margin-top: 1rem;
    }
    
    .ranking-excellent {
      background: rgba(16, 185, 129, 0.2);
      color: var(--success);
      border: 1px solid rgba(16, 185, 129, 0.3);
    }
    
    .ranking-good {
      background: rgba(59, 130, 246, 0.2);
      color: var(--primary);
      border: 1px solid rgba(59, 130, 246, 0.3);
    }
    
    .ranking-average {
      background: rgba(245, 158, 11, 0.2);
      color: var(--warning);
      border: 1px solid rgba(245, 158, 11, 0.3);
    }
    
    .ranking-poor {
      background: rgba(239, 68, 68, 0.2);
      color: var(--error);
      border: 1px solid rgba(239, 68, 68, 0.3);
    }
    
    .performance-indicator {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.5rem;
      font-size: 0.9rem;
    }
    
    .indicator-icon {
      font-size: 1.2rem;
    }
    
    .indicator-up {
      color: var(--success);
    }
    
    .indicator-down {
      color: var(--error);
    }
    
    .indicator-stable {
      color: var(--secondary);
    }
    
    .isp-benchmarks {
      margin-top: 1.5rem;
      padding: 1rem;
      background: var(--card-bg);
      border-radius: 8px;
      border: 1px solid var(--border);
    }
    
    .benchmark-title {
      font-weight: 600;
      color: var(--primary);
      margin-bottom: 0.75rem;
    }
    
    .benchmark-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }
    
    .benchmark-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 4px;
      border: 1px solid var(--border);
    }
    
    .benchmark-label {
      font-size: 0.9rem;
      color: var(--text);
    }
    
    .benchmark-value {
      font-weight: 600;
      color: var(--primary);
    }
    
    /* Performance Health Score */
    .health-score-container {
      background: linear-gradient(135deg, var(--card-bg) 0%, var(--card-bg2) 100%);
      border-radius: 12px;
      padding: 1.5rem;
      margin: 1.5rem 0;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      position: relative;
      overflow: hidden;
    }
    
    .health-score-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    
    .health-score-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--primary);
    }
    
    .health-score-value {
      font-size: 3rem;
      font-weight: 700;
      text-align: center;
      margin: 1rem 0;
      position: relative;
    }
    
    .health-score-excellent {
      background: linear-gradient(135deg, var(--success), #059669);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .health-score-good {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .health-score-average {
      background: linear-gradient(135deg, var(--warning), #d97706);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .health-score-poor {
      background: linear-gradient(135deg, var(--error), #dc2626);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .health-score-status {
      text-align: center;
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 1rem;
    }
    
    .health-score-trend {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
      font-size: 0.9rem;
    }
    
    .trend-up {
      color: var(--success);
    }
    
    .trend-down {
      color: var(--error);
    }
    
    .trend-stable {
      color: var(--secondary);
    }
    
    .health-metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    
    .health-metric {
      text-align: center;
      padding: 0.75rem;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      border: 1px solid var(--border);
    }
    
    .health-metric-label {
      font-size: 0.85rem;
      color: var(--secondary);
      margin-bottom: 0.25rem;
    }
    
    .health-metric-value {
      font-weight: 600;
      color: var(--text);
    }
    
    /* Smart Alerts */
    .alerts-container {
      margin: 1.5rem 0;
    }
    
    .alert-card {
      background: var(--card-bg);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      border-left: 4px solid var(--primary);
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      animation: slideIn 0.3s ease;
    }
    
    .alert-critical {
      border-left-color: var(--error);
      background: rgba(239, 68, 68, 0.05);
    }
    
    .alert-warning {
      border-left-color: var(--warning);
      background: rgba(245, 158, 11, 0.05);
    }
    
    .alert-info {
      border-left-color: var(--primary);
      background: rgba(59, 130, 246, 0.05);
    }
    
    .alert-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    
    .alert-title {
      font-weight: 600;
      color: var(--text);
    }
    
    .alert-time {
      font-size: 0.85rem;
      color: var(--secondary);
    }
    
    .alert-message {
      color: var(--text);
      margin-bottom: 0.5rem;
    }
    
    .alert-actions {
      display: flex;
      gap: 0.5rem;
    }
    
    .alert-btn {
      padding: 0.25rem 0.75rem;
      border-radius: 4px;
      font-size: 0.85rem;
      cursor: pointer;
      border: 1px solid var(--border);
      background: var(--container-bg);
      color: var(--text);
      transition: all 0.3s ease;
    }
    
    .alert-btn:hover {
      background: var(--primary);
      color: white;
    }
    
    /* Quick Actions */
    .quick-actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 1rem;
      margin: 1.5rem 0;
    }
    
    .quick-action-btn {
      background: linear-gradient(135deg, var(--card-bg) 0%, var(--card-bg2) 100%);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    
    .quick-action-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
      transition: left 0.5s;
    }
    
    .quick-action-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
      border-color: var(--primary);
    }
    
    .quick-action-btn:hover::before {
      left: 100%;
    }
    
    .quick-action-icon {
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
      display: block;
    }
    
    .quick-action-label {
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--text);
    }
    
    /* Time-of-Day Analysis */
    .time-analysis-container {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 1.5rem;
      margin: 1.5rem 0;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }
    
    .time-analysis-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    
    .time-analysis-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--primary);
    }
    
    .time-analysis-controls {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }
    
    .time-period-btn {
      background: var(--container-bg);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.9rem;
    }
    
    .time-period-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    .time-period-btn:hover {
      background: var(--primary);
      color: white;
      transform: translateY(-1px);
    }
    
    .heatmap-container {
      margin-top: 1rem;
      overflow-x: auto;
    }
    
    .heatmap-grid {
      display: grid;
      grid-template-columns: repeat(24, 1fr);
      gap: 2px;
      min-width: 800px;
    }
    
    .heatmap-cell {
      aspect-ratio: 1;
      border-radius: 2px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }
    
    .heatmap-cell:hover {
      transform: scale(1.2);
      z-index: 10;
    }
    
    .heatmap-cell.excellent {
      background: var(--success);
    }
    
    .heatmap-cell.good {
      background: var(--primary);
    }
    
    .heatmap-cell.average {
      background: var(--warning);
    }
    
    .heatmap-cell.poor {
      background: var(--error);
    }
    
    .heatmap-cell.empty {
      background: var(--border);
    }
    
    .heatmap-tooltip {
      position: absolute;
      background: var(--container-bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.5rem;
      font-size: 0.8rem;
      white-space: nowrap;
      z-index: 1000;
      box-shadow: var(--shadow-lg);
      display: none;
    }
    
    /* Enhanced Export Options */
    .export-options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin: 1.5rem 0;
    }
    
    .export-option {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .export-option:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
      border-color: var(--primary);
    }
    
    .export-option-icon {
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }
    
    .export-option-title {
      font-weight: 600;
      color: var(--text);
      margin-bottom: 0.25rem;
    }
    
    .export-option-desc {
      font-size: 0.85rem;
      color: var(--secondary);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Speedtest Dashboard</h1>
    
    <!-- Enhanced Main Controls -->
    <div class="main-controls">
      <!-- Primary Action Bar -->
      <div class="primary-actions">
        <button class="primary-btn" onclick="runTestNow()" aria-label="Run speedtest now">
          <span class="btn-icon">⚡</span>
          <span class="btn-text">Run Speed Test</span>
        </button>
        <div class="test-status-display">
          <span id="testStatusIndicator">⚡ Ready</span>
        </div>
      </div>

      <!-- Filter Controls Group -->
      <div class="filter-controls">
        <div class="control-group">
          <label class="control-label">Date Range</label>
          <div class="date-range-inputs">
            <input id="dateStart" type="date" class="control-input date-input" title="Start date">
            <span class="date-separator">to</span>
            <input id="dateEnd" type="date" class="control-input date-input" title="End date">
          </div>
        </div>
        <div class="control-group">
          <label class="control-label">Time Window</label>
          <select id="timeWindow" class="control-select">
            <option value="all">All Time</option>
            <option value="30">Last 30 Days</option>
            <option value="7">Last 7 Days</option>
          </select>
        </div>
        <div class="control-group checkbox-group">
          <label class="checkbox-label">
            <input type="checkbox" id="maToggle" class="control-checkbox">
            <span class="checkbox-text">Moving Average</span>
          </label>
        </div>
        <button class="secondary-btn" id="clearFilterBtn" onclick="clearDateFilter()" aria-label="Clear Date Filter">
          <span class="btn-icon">✕</span>
          Clear Filters
        </button>
      </div>

      <!-- Action Groups -->
      <div class="action-groups">
        <!-- Export Group -->
        <div class="btn-group" data-group="export">
          <button class="group-toggle" onclick="toggleGroup('export')">
            <span class="btn-icon">📤</span>
            Export
            <span class="group-arrow">▼</span>
          </button>
          <div class="group-dropdown">
            <button class="dropdown-btn" onclick="exportCSV()">📊 Export CSV</button>
            <button class="dropdown-btn" onclick="exportJSON()">📋 Export JSON</button>
            <button class="dropdown-btn" onclick="downloadPDF()">📑 Download PDF</button>
            <button class="dropdown-btn" onclick="shareSummary()">📤 Share Summary</button>
          </div>
        </div>

        <!-- Settings Group -->
        <div class="btn-group" data-group="settings">
          <button class="group-toggle" onclick="toggleGroup('settings')">
            <span class="btn-icon">⚙️</span>
            Settings
            <span class="group-arrow">▼</span>
          </button>
          <div class="group-dropdown">
            <button class="dropdown-btn" id="darkModeToggle">🌙 Dark Mode</button>
            <button class="dropdown-btn" id="autoUpdateBtn">🔄 Auto-Update</button>
          </div>
        </div>
      </div>
    </div>
    
    <div class="status-bar">
      <div class="last-updated">Last Updated: <span id="lastUpdated">Loading...</span></div>
      <div class="data-freshness">
        <span>Data Freshness:</span>
        <div class="freshness-indicator" id="freshnessIndicator"></div>
        <span id="freshnessText">Checking...</span>
      </div>
    </div>
    
    <div id="messageContainer"></div>
    
    <!-- Skeleton Loading -->
    <div id="skeletonLoading" class="dashboard-section">
      <div class="summary">
        <div class="summary-card latest-speed skeleton skeleton-card">
          <div class="skeleton skeleton-text"></div>
          <div class="skeleton skeleton-text" style="height: 2rem; margin: 0.5rem 0;"></div>
          <div class="skeleton skeleton-text" style="height: 0.8rem;"></div>
        </div>
        <div class="summary-card latest-speed skeleton skeleton-card">
          <div class="skeleton skeleton-text"></div>
          <div class="skeleton skeleton-text" style="height: 2rem; margin: 0.5rem 0;"></div>
          <div class="skeleton skeleton-text" style="height: 0.8rem;"></div>
        </div>
        <div class="summary-card skeleton skeleton-card">
          <div class="skeleton skeleton-text"></div>
          <div class="skeleton skeleton-text"></div>
        </div>
        <div class="summary-card skeleton skeleton-card">
          <div class="skeleton skeleton-text"></div>
          <div class="skeleton skeleton-text"></div>
        </div>
        <div class="summary-card skeleton skeleton-card">
          <div class="skeleton skeleton-text"></div>
          <div class="skeleton skeleton-text"></div>
        </div>
        <div class="summary-card skeleton skeleton-card">
          <div class="skeleton skeleton-text"></div>
          <div class="skeleton skeleton-text"></div>
        </div>
        <div class="summary-card skeleton skeleton-card">
          <div class="skeleton skeleton-text"></div>
          <div class="skeleton skeleton-text"></div>
        </div>
        <div class="summary-card skeleton skeleton-card">
          <div class="skeleton skeleton-text"></div>
          <div class="skeleton skeleton-text"></div>
        </div>
      </div>
    </div>
    
    <!-- Summary Stats Section -->
    <div class="dashboard-section" id="summarySection">
      <div class="section-header">
        <div class="section-title">Performance Summary</div>
        <button class="section-toggle" onclick="toggleSection('summarySection')">−</button>
      </div>
      <div class="section-content">
        <div class="summary" id="summaryStats"></div>
      </div>
    </div>
    
    <!-- Chart Section -->
    <div class="dashboard-section" id="chartSection">
      <div class="section-header">
        <div class="section-title">Speed Analysis</div>
        <button class="section-toggle" onclick="toggleSection('chartSection')">−</button>
      </div>
      <div class="section-content">
        <div class="chart-container">
          <div class="chart-controls">
            <button class="chart-type-btn active" onclick="switchChartType('line')">Line Chart</button>
            <button class="chart-type-btn" onclick="switchChartType('bar')">Bar Chart</button>
            <button class="chart-type-btn" onclick="switchChartType('heatmap')">Time Heatmap</button>
            <div class="chart-view-controls">
              <button class="chart-view-btn active" onclick="switchViewMode('3day')" id="threeDayBtn">3-Day View</button>
              <button class="chart-view-btn" onclick="switchViewMode('all')" id="allDataBtn">All Data</button>
            </div>
            <div class="chart-navigation" id="chartNavigation" style="display: flex; align-items: center; gap: 0.5rem;">
              <button class="nav-btn" onclick="navigateChart(-1)" id="prevBtn" title="Previous 3 days">‹</button>
              <span class="date-range-display" id="dateRangeDisplay">Last 3 days</span>
              <button class="nav-btn" onclick="navigateChart(1)" id="nextBtn" title="Next 3 days">›</button>
            </div>
            <button class="export-btn" onclick="exportChartPNG()" style="margin-left: auto;">Export PNG</button>
            <button class="export-btn" onclick="exportChartSVG()">Export SVG</button>
          </div>
          <canvas id="speedChart"></canvas>
        </div>
      </div>
    </div>
    
    <!-- ISP Comparison Section -->
    <div class="dashboard-section" id="ispComparisonSection">
      <div class="section-header">
        <div class="section-title">ISP Performance Comparison</div>
        <button class="section-toggle" onclick="toggleSection('ispComparisonSection')">−</button>
      </div>
      <div class="section-content">
        <div class="comparison-cards" id="ispComparisonCards">
          <!-- Comparison cards will be populated by JavaScript -->
        </div>
        
        <div class="isp-benchmarks">
          <div class="benchmark-title">Industry Benchmarks (Based on Ookla Data)</div>
          <div class="benchmark-grid" id="benchmarkGrid">
            <!-- Benchmark data will be populated by JavaScript -->
          </div>
        </div>
      </div>
    </div>
    
    <!-- Performance Health Score Section -->
    <div class="dashboard-section" id="healthScoreSection">
      <div class="section-header">
        <div class="section-title">Network Health Score</div>
        <button class="section-toggle" onclick="toggleSection('healthScoreSection')">−</button>
      </div>
      <div class="section-content">
        <div class="health-score-container" id="healthScoreContainer">
          <!-- Health score will be populated by JavaScript -->
        </div>
      </div>
    </div>
    
    <!-- Smart Alerts Section -->
    <div class="dashboard-section" id="alertsSection">
      <div class="section-header">
        <div class="section-title">Smart Alerts</div>
        <button class="section-toggle" onclick="toggleSection('alertsSection')">−</button>
      </div>
      <div class="section-content">
        <div class="alerts-container" id="alertsContainer">
          <!-- Alerts will be populated by JavaScript -->
        </div>
      </div>
    </div>
    
    <!-- Quick Actions Section -->
    <div class="dashboard-section" id="quickActionsSection">
      <div class="section-header">
        <div class="section-title">Quick Actions</div>
        <button class="section-toggle" onclick="toggleSection('quickActionsSection')">−</button>
      </div>
      <div class="section-content">
        <div class="quick-actions" id="quickActions">
          <!-- Quick actions will be populated by JavaScript -->
        </div>
      </div>
    </div>
    
    <!-- Time-of-Day Analysis Section -->
    <div class="dashboard-section" id="timeAnalysisSection">
      <div class="section-header">
        <div class="section-title">Time-of-Day Performance Analysis</div>
        <button class="section-toggle" onclick="toggleSection('timeAnalysisSection')">−</button>
      </div>
      <div class="section-content">
        <div class="time-analysis-container">
          <div class="time-analysis-header">
            <div class="time-analysis-title">Performance by Hour</div>
            <div class="time-analysis-controls">
              <button class="time-period-btn active" onclick="switchTimePeriod('hour')">Hourly</button>
              <button class="time-period-btn" onclick="switchTimePeriod('day')">Daily</button>
              <button class="time-period-btn" onclick="switchTimePeriod('week')">Weekly</button>
            </div>
          </div>
          <div class="heatmap-container">
            <div class="heatmap-grid" id="heatmapGrid">
              <!-- Heatmap will be populated by JavaScript -->
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Enhanced Export Options Section -->
    <div class="dashboard-section" id="exportOptionsSection">
      <div class="section-header">
        <div class="section-title">Export & Share Options</div>
        <button class="section-toggle" onclick="toggleSection('exportOptionsSection')">−</button>
      </div>
      <div class="section-content">
        <div class="export-options" id="exportOptions">
          <!-- Export options will be populated by JavaScript -->
        </div>
      </div>
    </div>
    
    <!-- Table Section -->
    <div class="dashboard-section" id="tableSection">
      <div class="section-header">
        <div class="section-title">Recent Tests (Last 2 Hours)</div>
        <button class="section-toggle" onclick="toggleSection('tableSection')">−</button>
      </div>
      <div class="section-content">
        <div class="table-container">
          <table id="resultsTable">
            <thead>
              <tr>
                <th class="sortable" data-sort="timestamp">Timestamp</th>
                <th class="sortable" data-sort="server_name">Server</th>
                <th class="sortable" data-sort="server_id">Server ID</th>
                <th class="sortable" data-sort="isp">ISP</th>
                <th class="sortable" data-sort="ping">Ping</th>
                <th class="sortable" data-sort="jitter">Jitter</th>
                <th class="sortable" data-sort="idle_latency">Idle Latency</th>
                <th class="sortable" data-sort="download">Download (Mbps)</th>
                <th class="sortable" data-sort="upload">Upload (Mbps)</th>
                <th class="sortable" data-sort="bytes_received">Bytes Received</th>
                <th class="sortable" data-sort="bytes_sent">Bytes Sent</th>
                <th class="sortable" data-sort="dl_latency">Download Latency</th>
                <th class="sortable" data-sort="ul_latency">Upload Latency</th>
                <th>Result URL</th>
              </tr>
            </thead>
            <tbody id="resultsBody"></tbody>
          </table>
        </div>
      </div>
    </div>
    
    <div id="outageWarning" class="outage"></div>
  </div>
  
  <div id="keyboardShortcuts" class="keyboard-shortcuts">
    <h3>Keyboard Shortcuts</h3>
    <p><kbd>Ctrl/Cmd + R</kbd> Refresh data</p>
    <p><kbd>Ctrl/Cmd + D</kbd> Toggle dark mode</p>
    <p><kbd>Ctrl/Cmd + A</kbd> Toggle auto-update</p>
    <p><kbd>Ctrl/Cmd + H</kbd> Show/hide this help</p>
    <p><kbd>Esc</kbd> Close dialogs</p>
    <button onclick="this.parentElement.classList.remove('show')" class="export-btn" style="margin-top: 1rem; width: 100%;">Close</button>
  </div>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js');
      });
    }
    
    // Mock Chart.js functionality for CSP compliance
    class MockChart {
      constructor(canvas, config) {
        this.canvas = canvas;
        this.data = config.data;
        this.options = config.options;
        this.type = config.type;
        this.render();
      }
      
      update(mode) {
        this.render();
      }
      
      render() {
        const ctx = this.canvas.getContext('2d');
        const width = this.canvas.width;
        const height = this.canvas.height;
        
        // Clear canvas
        ctx.clearRect(0, 0, width, height);
        
        // Simple chart rendering
        ctx.fillStyle = '#f0f0f0';
        ctx.fillRect(0, 0, width, height);
        
        ctx.fillStyle = '#333';
        ctx.font = '16px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(`${this.type.toUpperCase()} CHART`, width/2, height/2 - 20);
        ctx.fillText(`${this.data.labels ? this.data.labels.length : 0} data points`, width/2, height/2 + 20);
        
        // Draw simple line if we have data
        if (this.data.datasets && this.data.datasets.length > 0 && this.data.labels) {
          const dataset = this.data.datasets[0];
          if (dataset.data && dataset.data.length > 0) {
            ctx.strokeStyle = dataset.borderColor || '#2ecc40';
            ctx.lineWidth = 2;
            ctx.beginPath();
            
            const xStep = width / (dataset.data.length - 1);
            const maxVal = Math.max(...dataset.data);
            const minVal = Math.min(...dataset.data);
            const range = maxVal - minVal || 1;
            
            dataset.data.forEach((value, index) => {
              const x = index * xStep;
              const y = height - 50 - ((value - minVal) / range) * (height - 100);
              
              if (index === 0) {
                ctx.moveTo(x, y);
              } else {
                ctx.lineTo(x, y);
              }
            });
            
            ctx.stroke();
          }
        }
      }
    }
    
    // Mock Chart constructor
    window.Chart = MockChart;
    
    // Mock Papa Parse
    window.Papa = {
      parse: function(csv, options) {
        const lines = csv.split('\n');
        const headers = lines[0].split(',');
        const data = [];
        
        for (let i = 1; i < lines.length; i++) {
          if (lines[i].trim()) {
            const values = lines[i].split(',');
            const row = {};
            headers.forEach((header, index) => {
              row[header.trim()] = values[index] ? values[index].trim() : '';
            });
            data.push(row);
          }
        }
        
        return { data: data };
      }
    };
    
    // Mock flatpickr
    window.flatpickr = function(selector, options) {
      return {
        clear: function() {},
        close: function() {}
      };
    };
    let allData = [];
    let filteredData = [];
    let chart;
    let minDate, maxDate;
    let timeWindow = '7'; // Default to 7 days instead of 'all' for better performance
    let showMA = false;
    let autoRefreshTimer;
    let tableSortColumn = 'timestamp';
    let tableSortDirection = 'desc';
    let isLoading = false;
    let lastModified = null;
    let isTestRunning = false;
    let refreshInterval = 30000; // Default 30 seconds
    const IDLE_REFRESH_INTERVAL = 300000; // 5 minutes when idle
    const ACTIVE_REFRESH_INTERVAL = 10000; // 10 seconds when test running
    const DEFAULT_REFRESH_INTERVAL = 30000; // 30 seconds normal
    let currentChartType = 'line';
    let chartConfig = {
      line: { type: 'line', tension: 0.4 },
      bar: { type: 'bar', tension: 0 },
      heatmap: { type: 'line', tension: 0 }
    };
    let statisticalOverlays = {
      showStdDev: false,
      showConfidence: false,
      showTrends: true
    };
    let anomalyThresholds = {
      download: { low: 10, high: 100 },
      upload: { low: 5, high: 50 },
      ping: { low: 5, high: 100 }
    };
    
    // New variables for 3-day window navigation
    let currentDayOffset = 0; // 0 = most recent 3 days, 1 = previous 3 days, etc.
    let chartViewMode = '3day'; // '3day' for 3-day window, 'all' for original view
    
    // ISP Comparison Data (based on Ookla Global Index and industry averages)
    let ispBenchmarks = {
      global: {
        download: 580,
        upload: 65,
        ping: 15.3
      },
      fiber: {
        download: 850,
        upload: 95,
        ping: 8.2
      },
      cable: {
        download: 420,
        upload: 45,
        ping: 18.5
      },
      dsl: {
        download: 180,
        upload: 25,
        ping: 25.8
      },
      mobile: {
        download: 320,
        upload: 35,
        ping: 35.2
      }
    };
    
    // Major ISP performance data (example data - can be updated)
    let majorISPs = {
      'Comcast Xfinity': { download: 650, upload: 75, ping: 12.1 },
      'Verizon Fios': { download: 850, upload: 95, ping: 8.2 },
      'AT&T Fiber': { download: 820, upload: 90, ping: 9.1 },
      'Cox Communications': { download: 580, upload: 65, ping: 15.3 },
      'Spectrum': { download: 520, upload: 58, ping: 16.8 },
      'CenturyLink': { download: 480, upload: 52, ping: 18.2 },
      'Optimum': { download: 610, upload: 68, ping: 13.5 },
      'Frontier': { download: 420, upload: 45, ping: 20.1 }
    };
    
    // Alert system configuration
    let alertThresholds = {
      download: { warning: 500, critical: 300 },
      upload: { warning: 50, critical: 25 },
      ping: { warning: 20, critical: 50 },
      jitter: { warning: 5, critical: 10 }
    };
    
    let alerts = [];
    let currentTimePeriod = 'hour';
    let healthScore = null;

    function parseCSV(csv) {
      const results = Papa.parse(csv, { header: true, skipEmptyLines: true });
      return results.data
        .map(row => ({
          timestamp: row['Timestamp'],
          server_name: row['Server Name'],
          server_id: row['Server ID'],
          isp: row['ISP'],
          ping: parseFloat(row['Ping (ms)']),
          jitter: parseFloat(row['Jitter']),
          idle_latency: parseFloat(row['Idle Latency']),
          download: parseFloat(row['Download (Mbps)']),
          upload: parseFloat(row['Upload (Mbps)']),
          bytes_received: parseFloat(row['Bytes Received']),
          bytes_sent: parseFloat(row['Bytes Sent']),
          dl_latency: parseFloat(row['Download Latency']),
          ul_latency: parseFloat(row['Upload Latency']),
          result_url: row['Result URL']
        }))
        .filter(row => 
          // Validate data integrity
          row.timestamp && 
          !isNaN(row.ping) && row.ping >= 0 &&
          !isNaN(row.download) && row.download >= 0 &&
          !isNaN(row.upload) && row.upload >= 0 &&
          row.download < 10000 && // Reasonable max speed
          row.upload < 10000
        );
    }

    function updateSummaryStats(data) {
      if (!data.length) { document.getElementById('summaryStats').innerHTML = '<i>No data in range.</i>'; return; }
      
      const avg = arr => arr.reduce((a,b) => a+b,0)/arr.length;
      const min = arr => Math.min(...arr);
      const max = arr => Math.max(...arr);
      const dls = data.map(d=>d.download), uls = data.map(d=>d.upload), pings = data.map(d=>d.ping);
      
      // Get latest test results (most recent entry)
      const latest = data[data.length - 1];
      const latestTime = new Date(latest.timestamp).toLocaleString();
      const timeDiff = Date.now() - new Date(latest.timestamp).getTime();
      const timeAgo = formatTimeAgo(timeDiff);
      
      document.getElementById('summaryStats').innerHTML = `
        <div class="summary-card latest-speed">
          <b>Latest Download</b>
          <div class="latest-value">${latest.download.toFixed(2)} Mbps</div>
          <div class="latest-time">${timeAgo}</div>
        </div>
        <div class="summary-card latest-speed">
          <b>Latest Upload</b>
          <div class="latest-value">${latest.upload.toFixed(2)} Mbps</div>
          <div class="latest-time">${timeAgo}</div>
        </div>
        <div class="summary-card"><b>Avg Download</b><br>${avg(dls).toFixed(2)} Mbps</div>
        <div class="summary-card"><b>Max Download</b><br>${max(dls).toFixed(2)} Mbps</div>
        <div class="summary-card"><b>Avg Upload</b><br>${avg(uls).toFixed(2)} Mbps</div>
        <div class="summary-card"><b>Avg Ping</b><br>${avg(pings).toFixed(2)} ms</div>
        <div class="summary-card"><b>Tests</b><br>${data.length}</div>
        <div class="summary-card"><b>Latest Ping</b><br>${latest.ping.toFixed(2)} ms</div>
      `;
    }

    function formatTimeAgo(milliseconds) {
      const seconds = Math.floor(milliseconds / 1000);
      const minutes = Math.floor(seconds / 60);
      const hours = Math.floor(minutes / 60);
      const days = Math.floor(hours / 24);
      
      if (days > 0) return `${days}d ago`;
      if (hours > 0) return `${hours}h ago`;
      if (minutes > 0) return `${minutes}m ago`;
      return `${seconds}s ago`;
    }

    function updateOutageWarning(data) {
      const outages = data.filter(d => d.download < 1);
      document.getElementById('outageWarning').textContent = outages.length ?
        `WARNING: ${outages.length} outage(s) or zero/low download detected in range.` : '';
    }

    function updateChart(data) {
      // Detect mobile device for responsive configuration
      const isMobile = window.innerWidth <= 768;
      const isSmallMobile = window.innerWidth <= 480;
      
      const labels = data.map(d => d.timestamp);
      const download = data.map(d => d.download);
      const upload = data.map(d => d.upload);
      const ping = data.map(d => d.ping);
      
      // Outage/anomaly markers
      const anomalyPoints = download.map((d, i) => (d < 10 || ping[i] > 100) ? '#e74c3c' : '#2ecc40');
      
      // Moving average
      let ma = [];
      if (showMA && download.length > 1) {
        ma = movingAverage(download, 5);
      }
      
      // Get chart configuration based on current type
      const config = chartConfig[currentChartType] || chartConfig.line;
      
      // Prepare datasets based on chart type
      let datasets = [];
      
      if (currentChartType === 'bar') {
        // Bar chart configuration
        datasets = [
          {
            label: 'Download (Mbps)',
            data: download,
            backgroundColor: 'rgba(46, 204, 64, 0.8)',
            borderColor: '#2ecc40',
            borderWidth: isMobile ? 0.5 : 1,
            borderRadius: isMobile ? 2 : 4,
            pointBackgroundColor: anomalyPoints
          },
          {
            label: 'Upload (Mbps)',
            data: upload,
            backgroundColor: 'rgba(0, 116, 217, 0.8)',
            borderColor: '#0074d9',
            borderWidth: isMobile ? 0.5 : 1,
            borderRadius: isMobile ? 2 : 4
          },
          {
            label: 'Ping (ms)',
            data: ping,
            backgroundColor: 'rgba(255, 152, 0, 0.8)',
            borderColor: '#ff9800',
            borderWidth: isMobile ? 0.5 : 1,
            borderRadius: isMobile ? 2 : 4,
            borderDash: [6, 4]
          }
        ];
        
        // Add moving average as line overlay for bar charts
        if (showMA && ma.length) {
          datasets.push({
            label: 'Download MA (5)',
            data: ma,
            type: 'line',
            borderColor: '#ff69b4',
            borderDash: [8, 4],
            backgroundColor: 'transparent',
            fill: false,
            pointRadius: 0,
            borderWidth: 2,
            tension: 0.18
          });
        }
      } else if (currentChartType === 'heatmap') {
        // Heatmap-style line chart with enhanced styling
        datasets = [
          {
            label: 'Download (Mbps)',
            data: download,
            borderColor: '#2ecc40',
            backgroundColor: 'rgba(46, 204, 64, 0.2)',
            pointBackgroundColor: anomalyPoints,
            fill: true,
            tension: 0.4,
            pointRadius: isMobile ? (isSmallMobile ? 3 : 4) : 6,
            pointHoverRadius: isMobile ? (isSmallMobile ? 5 : 6) : 8,
            borderWidth: isMobile ? 2 : 3,
            pointBorderWidth: isMobile ? 1 : 2,
            pointBorderColor: '#2ecc40'
          },
          {
            label: 'Upload (Mbps)',
            data: upload,
            borderColor: '#0074d9',
            backgroundColor: 'rgba(0, 116, 217, 0.2)',
            fill: true,
            tension: 0.4,
            pointRadius: isMobile ? (isSmallMobile ? 2.5 : 3.5) : 5,
            pointHoverRadius: isMobile ? (isSmallMobile ? 4.5 : 5.5) : 7,
            borderWidth: isMobile ? 2 : 3,
            pointBorderWidth: isMobile ? 1 : 2,
            pointBorderColor: '#0074d9'
          },
          {
            label: 'Ping (ms)',
            data: ping,
            borderColor: '#ff9800',
            backgroundColor: 'rgba(255, 152, 0, 0.2)',
            fill: true,
            tension: 0.4,
            pointRadius: isMobile ? (isSmallMobile ? 2 : 3) : 4,
            pointHoverRadius: isMobile ? (isSmallMobile ? 4 : 5) : 6,
            borderDash: [6, 4],
            borderWidth: isMobile ? 2 : 3,
            pointBorderWidth: isMobile ? 1 : 2,
            pointBorderColor: '#ff9800'
          }
        ];
        
        // Add moving average
        if (showMA && ma.length) {
          datasets.push({
            label: 'Download MA (5)',
            data: ma,
            borderColor: '#ff69b4',
            borderDash: [8, 4],
            backgroundColor: 'transparent',
            fill: false,
            pointRadius: 0,
            borderWidth: 2,
            tension: 0.18
          });
        }
      } else {
        // Default line chart
        datasets = [
          {
            label: 'Download (Mbps)',
            data: download,
            borderColor: '#2ecc40',
            backgroundColor: 'rgba(46, 204, 64, 0.08)',
            pointBackgroundColor: anomalyPoints,
            fill: true,
            tension: 0.18,
            pointRadius: isMobile ? (isSmallMobile ? 2 : 3) : 4,
            pointHoverRadius: isMobile ? (isSmallMobile ? 4 : 5) : 6,
            borderWidth: isMobile ? 1.5 : 2
          },
          {
            label: 'Upload (Mbps)',
            data: upload,
            borderColor: '#0074d9',
            backgroundColor: 'rgba(0, 116, 217, 0.07)',
            fill: true,
            tension: 0.18,
            pointRadius: isMobile ? (isSmallMobile ? 1.5 : 2.5) : 3,
            pointHoverRadius: isMobile ? (isSmallMobile ? 3.5 : 4.5) : 5,
            borderWidth: isMobile ? 1.5 : 2
          },
          {
            label: 'Ping (ms)',
            data: ping,
            borderColor: '#ff9800',
            backgroundColor: 'rgba(255, 152, 0, 0.07)',
            fill: true,
            tension: 0.18,
            pointRadius: isMobile ? (isSmallMobile ? 1 : 2) : 2,
            pointHoverRadius: isMobile ? (isSmallMobile ? 3 : 4) : 4,
            borderDash: [6, 4],
            borderWidth: isMobile ? 1.5 : 2
          }
        ];
        
        // Add moving average
        if (showMA && ma.length) {
          datasets.push({
            label: 'Download MA (5)',
            data: ma,
            borderColor: '#ff69b4',
            borderDash: [8, 4],
            fill: false,
            pointRadius: 0,
            borderWidth: 2,
            tension: 0.18
          });
        }
      }
      
      // Add statistical overlays if enabled
      if (statisticalOverlays.showStdDev || statisticalOverlays.showConfidence) {
        const overlays = generateStatisticalOverlays(data);
        datasets = datasets.concat(overlays);
      }
      
      // Mobile-specific chart options
      const mobileOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { 
            display: true, 
            position: isMobile ? 'bottom' : 'top',
            labels: { 
              usePointStyle: true, 
              font: { size: isMobile ? 10 : 14 },
              color: getComputedStyle(document.body).getPropertyValue('--text'),
              padding: isMobile ? 8 : 10,
              boxWidth: isMobile ? 12 : 16
            } 
          },
          title: {
            display: true,
            text: getChartTitle(),
            font: { 
              size: isMobile ? (isSmallMobile ? 14 : 16) : 20, 
              weight: 'bold' 
            },
            color: getComputedStyle(document.body).getPropertyValue('--primary'),
            padding: { 
              top: isMobile ? 5 : 10, 
              bottom: isMobile ? 10 : 20 
            }
          },
          zoom: {
            pan: { enabled: true, mode: 'x' },
            zoom: { 
              wheel: { enabled: !isMobile }, 
              pinch: { enabled: true }, 
              mode: 'x',
              drag: { enabled: true }
            }
          },
          tooltip: {
            backgroundColor: getComputedStyle(document.body).getPropertyValue('--container-bg'),
            titleColor: getComputedStyle(document.body).getPropertyValue('--text'),
            bodyColor: getComputedStyle(document.body).getPropertyValue('--text'),
            borderColor: getComputedStyle(document.body).getPropertyValue('--border'),
            borderWidth: 1,
            titleFont: { size: isMobile ? 11 : 14 },
            bodyFont: { size: isMobile ? 10 : 12 },
            padding: isMobile ? 8 : 12,
            callbacks: {
              label: function(ctx) {
                const d = data[ctx.dataIndex];
                const isAnomaly = detectAnomaly(d);
                let labels = [
                  `Download: ${d.download} Mbps`,
                  `Upload: ${d.upload} Mbps`,
                  `Ping: ${d.ping} ms`,
                  `Time: ${d.timestamp}`
                ];
                
                if (isAnomaly) {
                  labels.push('⚠️ Anomaly detected');
                }
                
                return labels;
              }
            }
          }
        },
        scales: {
          x: {
            title: {
              display: true,
              text: 'Timestamp',
              font: { 
                size: isMobile ? (isSmallMobile ? 10 : 12) : 15, 
                weight: 'bold' 
              },
              color: getComputedStyle(document.body).getPropertyValue('--primary'),
              padding: { top: isMobile ? 5 : 10 }
            },
            ticks: { 
              maxTicksLimit: isMobile ? 8 : 20,
              color: getComputedStyle(document.body).getPropertyValue('--text'), 
              font: { size: isMobile ? 9 : 12 },
              maxRotation: isMobile ? 45 : 0,
              minRotation: isMobile ? 45 : 0
            },
            grid: { 
              color: getComputedStyle(document.body).getPropertyValue('--border') 
            }
          },
          y: {
            title: {
              display: true,
              text: 'Speed (Mbps) / Ping (ms)',
              font: { 
                size: isMobile ? (isSmallMobile ? 10 : 12) : 15, 
                weight: 'bold' 
              },
              color: getComputedStyle(document.body).getPropertyValue('--primary'),
              padding: { bottom: isMobile ? 5 : 10 }
            },
            beginAtZero: true,
            ticks: { 
              color: getComputedStyle(document.body).getPropertyValue('--text'), 
              font: { size: isMobile ? 9 : 12 },
              maxTicksLimit: isMobile ? 6 : 10
            },
            grid: { 
              color: getComputedStyle(document.body).getPropertyValue('--border') 
            }
          }
        },
        interaction: {
          mode: isMobile ? 'nearest' : 'index',
          intersect: false
        },
        elements: {
          point: {
            radius: isMobile ? (isSmallMobile ? 2 : 3) : 4,
            hoverRadius: isMobile ? (isSmallMobile ? 4 : 5) : 6
          },
          line: {
            borderWidth: isMobile ? 1.5 : 2
          }
        }
      };
      
      // Update existing chart if it exists, otherwise create new one
      if (chart) {
        // Update data
        chart.data.labels = labels;
        chart.data.datasets = datasets;
        
        // Update options if needed (for responsive changes)
        chart.options = mobileOptions;
        
        // Apply changes with proper animation mode
        chart.update('resize'); // Use 'resize' mode to handle dimension changes
      } else {
        // Create new chart
        chart = new Chart(document.getElementById('speedChart').getContext('2d'), {
          type: config.type,
          data: {
            labels,
            datasets
          },
          options: mobileOptions
        });
      }
    }
    
    function getChartTitle() {
      const isMobile = window.innerWidth <= 768;
      const isSmallMobile = window.innerWidth <= 480;
      
      if (isSmallMobile) {
        const shortTitles = {
          line: 'Speed Over Time',
          bar: 'Speed Comparison',
          heatmap: 'Speed Heatmap'
        };
        return shortTitles[currentChartType] || shortTitles.line;
      } else if (isMobile) {
        const mobileTitles = {
          line: 'Internet Speed Over Time',
          bar: 'Internet Speed Comparison',
          heatmap: 'Internet Speed Heatmap'
        };
        return mobileTitles[currentChartType] || mobileTitles.line;
      } else {
        const titles = {
          line: 'Internet Speed Over Time (Line Chart)',
          bar: 'Internet Speed Comparison (Bar Chart)',
          heatmap: 'Internet Speed Heatmap (Enhanced View)'
        };
        return titles[currentChartType] || titles.line;
      }
    }

    function updateTable(data) {
      // Filter data to show only the last 2 hours for the table
      const twoHoursAgo = Date.now() - (2 * 60 * 60 * 1000); // 2 hours in milliseconds
      const recentData = data.filter(d => new Date(d.timestamp).getTime() >= twoHoursAgo);
      
      // Sort the data
      const sortedData = sortTableData(recentData, tableSortColumn, tableSortDirection);
      
      const tbody = document.getElementById('resultsBody');
      tbody.innerHTML = '';
      sortedData.forEach(d => {
        const isAnomaly = detectAnomaly(d);
        const rowClass = isAnomaly ? 'anomaly-row' : '';
        tbody.innerHTML += `<tr class="${rowClass}">
          <td>${d.timestamp}</td>
          <td>${d.server_name}</td>
          <td>${d.server_id}</td>
          <td>${d.isp}</td>
          <td>${d.ping}</td>
          <td>${d.jitter}</td>
          <td>${d.idle_latency}</td>
          <td>${d.download}</td>
          <td>${d.upload}</td>
          <td>${d.bytes_received}</td>
          <td>${d.bytes_sent}</td>
          <td>${d.dl_latency}</td>
          <td>${d.ul_latency}</td>
          <td><a href="${d.result_url}" target="_blank">View</a></td>
        </tr>`;
      });
    }

    function sortTableData(data, column, direction) {
      return [...data].sort((a, b) => {
        let aVal = a[column];
        let bVal = b[column];
        
        // Handle numeric values
        if (typeof aVal === 'number' && typeof bVal === 'number') {
          return direction === 'asc' ? aVal - bVal : bVal - aVal;
        }
        
        // Handle string values
        aVal = String(aVal || '').toLowerCase();
        bVal = String(bVal || '').toLowerCase();
        
        if (direction === 'asc') {
          return aVal.localeCompare(bVal);
        } else {
          return bVal.localeCompare(aVal);
        }
      });
    }

    function updateTableHeaders() {
      const headers = document.querySelectorAll('th.sortable');
      headers.forEach(header => {
        header.classList.remove('sort-asc', 'sort-desc');
        if (header.dataset.sort === tableSortColumn) {
          header.classList.add(tableSortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
        }
      });
    }

    function showMessage(message, type = 'info') {
      const container = document.getElementById('messageContainer');
      const messageDiv = document.createElement('div');
      messageDiv.className = type === 'error' ? 'error-message' : 'success-message';
      messageDiv.textContent = message;
      
      container.innerHTML = '';
      container.appendChild(messageDiv);
      
      // Auto-remove after 5 seconds
      setTimeout(() => {
        if (messageDiv.parentNode) {
          messageDiv.remove();
        }
      }, 5000);
    }

    function showSkeletonLoading() {
      const skeleton = document.getElementById('skeletonLoading');
      if (skeleton) skeleton.style.display = 'block';
    }
    
    function hideSkeletonLoading() {
      const skeleton = document.getElementById('skeletonLoading');
      if (skeleton) skeleton.style.display = 'none';
    }
    
    function updateStatus(message, type) {
      // Simple status update
      console.log(`Status: ${message || 'Ready'} (${type || 'info'})`);
    }
    
    function updateStatus() {
      const now = new Date();
      document.getElementById('lastUpdated').textContent = now.toLocaleTimeString();
      
      // Update data freshness
      if (allData.length > 0) {
        const latestTest = new Date(allData[allData.length - 1].timestamp);
        const timeDiff = now - latestTest;
        const minutesDiff = Math.floor(timeDiff / (1000 * 60));
        
        const indicator = document.getElementById('freshnessIndicator');
        const text = document.getElementById('freshnessText');
        
        if (minutesDiff <= 10) {
          indicator.className = 'freshness-indicator freshness-fresh';
          text.textContent = 'Fresh (< 10 min)';
        } else if (minutesDiff <= 60) {
          indicator.className = 'freshness-indicator freshness-stale';
          text.textContent = 'Stale (< 1 hour)';
        } else {
          indicator.className = 'freshness-indicator freshness-old';
          text.textContent = 'Old (> 1 hour)';
        }
      }
    }

    function setupKeyboardShortcuts() {
      document.addEventListener('keydown', (e) => {
        // Don't trigger shortcuts when typing in input fields
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
        
        switch(e.key.toLowerCase()) {
          case 'r':
            e.preventDefault();
            if (!isLoading) loadData();
            break;
          case 'e':
            e.preventDefault();
            exportCSV();
            break;
          case 'j':
            e.preventDefault();
            exportJSON();
            break;
          case 't':
            e.preventDefault();
            runTestNow();
            break;
          case 'd':
            e.preventDefault();
            toggleDarkMode();
            break;
          case '?':
            e.preventDefault();
            toggleKeyboardShortcuts();
            break;
        }
      });
    }

    function toggleKeyboardShortcuts() {
      const shortcuts = document.getElementById('keyboardShortcuts');
      shortcuts.classList.toggle('show');
    }

    function setupTableSorting() {
      document.querySelectorAll('th.sortable').forEach(header => {
        header.addEventListener('click', () => {
          const column = header.dataset.sort;
          
          if (tableSortColumn === column) {
            tableSortDirection = tableSortDirection === 'asc' ? 'desc' : 'asc';
          } else {
            tableSortColumn = column;
            tableSortDirection = 'asc';
          }
          
          updateTable(filteredData);
        });
      });
    }

    async function checkForNewData() {
      try {
        const response = await fetch('/speedtest/results.csv', { method: 'HEAD' });
        const currentModified = response.headers.get('Last-Modified');
        
        if (lastModified === null) {
          lastModified = currentModified;
          return true; // First load
        }
        
        if (currentModified !== lastModified) {
          lastModified = currentModified;
          return true; // Data has changed
        }
        
        return false; // No changes
      } catch (error) {
        console.warn('Error checking for new data:', error);
        return true; // Fallback to loading on error
      }
    }

    function adjustRefreshInterval() {
      const newInterval = isTestRunning ? ACTIVE_REFRESH_INTERVAL : 
                         (allData.length === 0 || Date.now() - new Date(allData[0]?.timestamp).getTime() > 3600000) ? 
                         IDLE_REFRESH_INTERVAL : DEFAULT_REFRESH_INTERVAL;
      
      if (newInterval !== refreshInterval) {
        refreshInterval = newInterval;
        if (autoRefreshTimer) {
          startAutoRefresh(); // Restart with new interval
        }
      }
    }

    function updateTestStatus() {
      const statusIndicator = document.getElementById('testStatusIndicator');
      const testBtn = document.querySelector('.primary-btn');
      
      if (isTestRunning) {
        if (statusIndicator) {
          statusIndicator.textContent = '⚡ Test Running...';
          statusIndicator.style.color = '#ff9800';
        }
        if (testBtn) {
          testBtn.querySelector('.btn-text').textContent = 'Running Test...';
          testBtn.querySelector('.btn-icon').textContent = '⏳';
          testBtn.disabled = true;
        }
      } else {
        if (statusIndicator) {
          statusIndicator.textContent = '⚡ Ready';
          statusIndicator.style.color = '#4caf50';
        }
        if (testBtn) {
          testBtn.querySelector('.btn-text').textContent = 'Run Speed Test';
          testBtn.querySelector('.btn-icon').textContent = '⚡';
          testBtn.disabled = false;
        }
      }
    }

    function toggleGroup(groupName) {
      const group = document.querySelector(`[data-group="${groupName}"]`);
      const isActive = group.classList.contains('active');
      
      // Close all other groups
      document.querySelectorAll('.btn-group.active').forEach(g => {
        if (g !== group) g.classList.remove('active');
      });
      
      // Toggle current group
      group.classList.toggle('active', !isActive);
    }

    // Close dropdowns when clicking outside
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.btn-group')) {
        document.querySelectorAll('.btn-group.active').forEach(g => {
          g.classList.remove('active');
        });
      }
    });

    async function checkTestStatus() {
      try {
        // Check if speedtest process is running by looking for recent activity
        const response = await fetch('/speedtest/results.csv', { method: 'HEAD' });
        const currentModified = response.headers.get('Last-Modified');
        
        if (currentModified && lastModified) {
          const timeDiff = new Date(currentModified).getTime() - new Date(lastModified).getTime();
          // Consider test running if CSV was modified in last 2 minutes
          const wasTestRunning = isTestRunning;
          isTestRunning = timeDiff < 120000;
          
          if (wasTestRunning !== isTestRunning) {
            adjustRefreshInterval();
            updateTestStatus();
          }
        }
      } catch (error) {
        console.warn('Error checking test status:', error);
      }
    }

    function startAutoRefresh() {
      // Clear existing timer
      if (autoRefreshTimer) {
        clearInterval(autoRefreshTimer);
      }
      
      // Start new timer with smart refresh logic
      autoRefreshTimer = setInterval(async () => {
        if (!isLoading) {
          await checkTestStatus();
          const hasNewData = await checkForNewData();
          if (hasNewData) {
            loadData();
          }
        }
      }, refreshInterval);
    }

    function loadData() {
      if (isLoading) return;
      isLoading = true;
      
      showSkeletonLoading(); // Show skeleton while loading
      updateStatus('Loading data...', 'loading');
      
      // Try to fetch real data, but fallback to mock data for demo
      fetch('/speedtest/results.csv')
        .then(response => {
          if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          // Update lastModified from response headers
          const currentModified = response.headers.get('Last-Modified');
          if (currentModified) {
            lastModified = currentModified;
          }
          return response.text();
        })
        .then(csv => {
          allData = parseCSV(csv);
          if (allData.length === 0) {
            throw new Error('No data in CSV file');
          }
          
          updateAll();
          updateStatus();
          showMessage('Data refreshed successfully', 'success');
          hideSkeletonLoading();
          
          // Setup date inputs if not already done
          if (!window.datePickerInitialized) {
            setupDateRangeInputs();
            window.datePickerInitialized = true;
          }
        })
        .catch(error => {
          console.log('CSV loading failed, using mock data for demo:', error.message);
          
          // Generate mock data for the last 7 days
          allData = generateMockData();
          updateAll();
          updateStatus();
          showMessage('Using demo data - CSV file not found', 'info');
          hideSkeletonLoading();
          
          // Setup date inputs for mock data too
          if (!window.datePickerInitialized) {
            setupDateRangeInputs();
            window.datePickerInitialized = true;
          }
        })
        .finally(() => {
          isLoading = false;
        });
    }
    
    function generateMockData() {
      const mockData = [];
      const now = new Date();
      
      // Generate data for the last 7 days, every 2 hours
      for (let day = 6; day >= 0; day--) {
        for (let hour = 0; hour < 24; hour += 2) {
          const timestamp = new Date(now);
          timestamp.setDate(timestamp.getDate() - day);
          timestamp.setHours(hour, 0, 0, 0);
          
          // Generate random but realistic values
          const baseDownload = 450 + Math.sin(hour/24 * Math.PI * 2) * 50; // Vary by time of day
          const baseUpload = 45 + Math.sin(hour/24 * Math.PI * 2) * 5;
          const basePing = 15 + Math.sin(hour/24 * Math.PI * 2) * 3;
          
          mockData.push({
            timestamp: timestamp.toISOString(),
            server_name: 'Demo Server',
            server_id: '12345',
            isp: 'Demo ISP',
            ping: Math.max(5, basePing + (Math.random() - 0.5) * 10),
            jitter: Math.random() * 2,
            idle_latency: Math.random() * 5,
            download: Math.max(10, baseDownload + (Math.random() - 0.5) * 100),
            upload: Math.max(5, baseUpload + (Math.random() - 0.5) * 20),
            bytes_received: Math.floor(Math.random() * 1000000000),
            bytes_sent: Math.floor(Math.random() * 100000000),
            dl_latency: Math.random() * 20,
            ul_latency: Math.random() * 30,
            result_url: 'https://example.com/result'
          });
        }
      }
      
      return mockData.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
    }

    function filterByDateRange(data, start, end) {
      return data.filter(d => {
        const t = new Date(d.timestamp).getTime();
        return (!start || t >= start) && (!end || t <= end);
      });
    }

    function filterByTimeWindow(data) {
      if (timeWindow === 'all') return data;
      const days = parseInt(timeWindow, 10);
      const cutoff = Date.now() - days * 24 * 60 * 60 * 1000;
      return data.filter(d => new Date(d.timestamp).getTime() >= cutoff);
    }
    
    function filterBy3DayWindow(data) {
      if (chartViewMode === 'all') return data;
      
      // Calculate the date range for the current 3-day window
      const threeDaysMs = 3 * 24 * 60 * 60 * 1000;
      const now = Date.now();
      const windowEndTime = now - (currentDayOffset * threeDaysMs);
      const windowStartTime = windowEndTime - threeDaysMs;
      
      const filtered = data.filter(d => {
        const timestamp = new Date(d.timestamp).getTime();
        return timestamp >= windowStartTime && timestamp <= windowEndTime;
      });
      
      console.log(`3-day filter: ${data.length} -> ${filtered.length} items, window: ${new Date(windowStartTime)} to ${new Date(windowEndTime)}`);
      return filtered;
    }

    function movingAverage(arr, windowSize) {
      if (!arr.length) return [];
      let res = [];
      for (let i = 0; i < arr.length; i++) {
        let start = Math.max(0, i - windowSize + 1);
        let window = arr.slice(start, i + 1);
        res.push(window.reduce((a, b) => a + b, 0) / window.length);
      }
      return res;
    }

    function exportCSV() {
      let csv = 'Timestamp,Ping (ms),Download (Mbps),Upload (Mbps)\n';
      filteredData.forEach(d => {
        csv += `${d.timestamp},${d.ping},${d.download},${d.upload}\n`;
      });
      const blob = new Blob([csv], {type: 'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'speedtest_export.csv'; a.click();
      URL.revokeObjectURL(url);
    }

    function exportJSON() {
      const blob = new Blob([JSON.stringify(filteredData, null, 2)], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'speedtest_export.json'; a.click();
      URL.revokeObjectURL(url);
    }

    function showFilterNotice() {
      const notice = document.getElementById('filterNotice');
      if (filteredData.length !== allData.length) {
        notice.style.display = 'block';
      } else {
        notice.style.display = 'none';
      }
    }

    function setupDateRangeInputs() {
      const dateStart = document.getElementById('dateStart');
      const dateEnd = document.getElementById('dateEnd');
      
      if (dateStart && dateEnd) {
        // Set default values to show available data range
        if (allData.length > 0) {
          const oldestDate = new Date(allData[0].timestamp);
          const newestDate = new Date(allData[allData.length - 1].timestamp);
          
          dateStart.min = oldestDate.toISOString().split('T')[0];
          dateStart.max = newestDate.toISOString().split('T')[0];
          dateEnd.min = oldestDate.toISOString().split('T')[0];
          dateEnd.max = newestDate.toISOString().split('T')[0];
        }
        
        // Add event listeners
        dateStart.addEventListener('change', handleDateRangeChange);
        dateEnd.addEventListener('change', handleDateRangeChange);
      }
    }
    
    function handleDateRangeChange() {
      const dateStart = document.getElementById('dateStart');
      const dateEnd = document.getElementById('dateEnd');
      
      if (dateStart && dateEnd && dateStart.value && dateEnd.value) {
        const startDate = new Date(dateStart.value);
        const endDate = new Date(dateEnd.value);
        
        // Ensure end date is after start date
        if (endDate < startDate) {
          dateEnd.value = dateStart.value;
          return;
        }
        
        // Set end of day for end date to include all data from that day
        endDate.setHours(23, 59, 59, 999);
        
        minDate = startDate;
        maxDate = endDate;
        
        console.log(`Date range filter: ${startDate.toLocaleDateString()} to ${endDate.toLocaleDateString()}`);
        
        // Apply the date range filter
        const timeFilteredData = filterByTimeWindow(allData);
        filteredData = filterByDateRange(timeFilteredData, startDate.getTime(), endDate.getTime());
        
        updateAll();
        showFilterNotice();
      }
    }
    
    function clearDateFilter() {
      const dateStart = document.getElementById('dateStart');
      const dateEnd = document.getElementById('dateEnd');
      
      if (dateStart) dateStart.value = '';
      if (dateEnd) dateEnd.value = '';
      
      minDate = null;
      maxDate = null;
      
      filteredData = allData.slice();
      updateAll();
      showFilterNotice();
    }

    function updateAll() {
      if (allData.length === 0) return;
      
      // Apply time window filter first, then 3-day window filter for chart
      const timeFilteredData = filterByTimeWindow(allData);
      let chartData;
      
      if (chartViewMode === '3day') {
        chartData = filterBy3DayWindow(timeFilteredData);
        console.log(`Chart data filtered: ${timeFilteredData.length} -> ${chartData.length} for 3-day view`);
      } else {
        chartData = timeFilteredData;
        console.log(`Chart data: ${chartData.length} items in all-data view`);
      }
      
      filteredData = timeFilteredData; // Keep using timeFilteredData for other components
      updateSummaryStats(filteredData);
      updateChart(chartData); // Use 3-day filtered data for chart
      updateTable(filteredData);
      updateISPComparison(filteredData);
      updateHealthScore(filteredData);
      checkAlerts(filteredData);
      updateQuickActions();
      updateTimeAnalysis(filteredData);
      updateExportOptions();
      updateNavigationState();
    }

    function switchViewMode(mode) {
      console.log(`Switching view mode to: ${mode}`);
      chartViewMode = mode;
      currentDayOffset = 0; // Reset to most recent window when switching modes
      
      // Update button states
      const threeDayBtn = document.getElementById('threeDayBtn');
      const allDataBtn = document.getElementById('allDataBtn');
      
      if (threeDayBtn && allDataBtn) {
        threeDayBtn.classList.toggle('active', mode === '3day');
        allDataBtn.classList.toggle('active', mode === 'all');
      }
      
      // Show/hide navigation controls
      const navigation = document.getElementById('chartNavigation');
      if (navigation) {
        navigation.style.display = mode === '3day' ? 'flex' : 'none';
      }
      
      updateAll();
    }
    
    function navigateChart(direction) {
      if (chartViewMode !== '3day') return;
      
      const newOffset = currentDayOffset + direction;
      
      // Calculate maximum offset based on available data
      if (allData.length > 0) {
        const oldestDataTime = new Date(allData[0].timestamp).getTime();
        const now = Date.now();
        const maxPossibleOffset = Math.floor((now - oldestDataTime) / (3 * 24 * 60 * 60 * 1000));
        
        // Ensure we don't go beyond available data or into the future
        if (newOffset >= 0 && newOffset <= maxPossibleOffset) {
          currentDayOffset = newOffset;
          updateAll();
        }
      }
    }
    
    function updateNavigationState() {
      if (chartViewMode !== '3day') return;
      
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const dateDisplay = document.getElementById('dateRangeDisplay');
      
      // Check if elements exist before using them
      if (!prevBtn || !nextBtn || !dateDisplay) {
        console.log('Navigation elements not found in DOM');
        return;
      }
      
      // Calculate if navigation buttons should be enabled
      if (allData.length > 0) {
        const oldestDataTime = new Date(allData[0].timestamp).getTime();
        const now = Date.now();
        const maxPossibleOffset = Math.floor((now - oldestDataTime) / (3 * 24 * 60 * 60 * 1000));
        
        // Enable/disable buttons
        nextBtn.disabled = currentDayOffset <= 0;
        prevBtn.disabled = currentDayOffset >= maxPossibleOffset;
        
        // Update date range display
        const threeDaysMs = 3 * 24 * 60 * 60 * 1000;
        const windowEndTime = now - (currentDayOffset * threeDaysMs);
        const windowStartTime = windowEndTime - threeDaysMs;
        
        const startDate = new Date(windowStartTime).toLocaleDateString();
        const endDate = new Date(windowEndTime).toLocaleDateString();
        
        if (currentDayOffset === 0) {
          dateDisplay.textContent = 'Last 3 days';
        } else {
          dateDisplay.textContent = `${startDate} - ${endDate}`;
        }
      } else {
        prevBtn.disabled = true;
        nextBtn.disabled = true;
        dateDisplay.textContent = 'No data';
      }
    }
    
    async function runTestNow() {
      if (isTestRunning) {
        showMessage('Speed test already running...', 'warning');
        return;
      }

      try {
        showMessage('Initiating speed test...', 'info');
        isTestRunning = true;
        adjustRefreshInterval();
        updateTestStatus();

        // Trigger the speedtest script via API
        const response = await fetch('/speedtest/api/run-test', { 
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          }
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();
        showMessage('Speed test initiated successfully', 'success');
        
        // The test will run in background, auto-refresh will pick up results
        
      } catch (error) {
        console.error('Error running speed test:', error);
        showMessage('Failed to start speed test: ' + error.message, 'error');
        isTestRunning = false;
        adjustRefreshInterval();
        updateTestStatus();
      }
    }

    function downloadPDF() {
      fetch('/speedtest/api/export-pdf')
        .then(response => {
          if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          return response.blob();
        })
        .then(blob => {
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'speedtest.pdf';
          document.body.appendChild(a);
          a.click();
          a.remove();
          window.URL.revokeObjectURL(url);
          showMessage('PDF downloaded successfully', 'success');
        })
        .catch(error => {
          console.error('PDF export error:', error);
          showMessage('PDF export failed: ' + error.message, 'error');
        });
    }

    function shareSummary() {
      const summary = healthScore ? 
        `Network Health Score: ${healthScore.score}/100 (${healthScore.status.label})` :
        'Speedtest Dashboard Summary';
      
      if (navigator.share) {
        navigator.share({
          title: 'Speedtest Dashboard',
          text: summary,
          url: window.location.href
        });
      } else {
        // Fallback: copy to clipboard
        navigator.clipboard.writeText(summary).then(() => {
          showMessage('Summary copied to clipboard', 'success');
        });
      }
    }

    // Removed duplicate dark mode toggle function - consolidated below

    document.getElementById('timeWindow').onchange = function() {
      timeWindow = this.value;
      updateAll();
    };
    document.getElementById('maToggle').onchange = function() {
      showMA = this.checked;
      updateAll();
    };

    document.getElementById('autoUpdateBtn').onclick = function() {
      if (!confirm('Run auto-update? This will update code, dependencies, and restart services.')) return;
      this.disabled = true;
      fetch('/speedtest/api/auto-update', { method: 'POST' })
        .then(r => {
          if (!r.ok) throw new Error(`HTTP ${r.status}: ${r.statusText}`);
          return r.json();
        })
        .then(data => {
          if (data.success) {
            showMessage('Update complete!\n' + data.output, 'success');
          } else {
            showMessage('Update failed: ' + (data.error || 'Unknown error'), 'error');
          }
          this.disabled = false;
        })
        .catch(error => {
          console.error('Auto-update error:', error);
          showMessage('Update failed: ' + error.message, 'error');
          this.disabled = false;
        });
    };

    function switchChartType(type) {
      currentChartType = type;
      
      // Update button states
      document.querySelectorAll('.chart-type-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
      
      // Destroy and recreate chart with new type
      if (chart) {
        chart.destroy();
        chart = null;
      }
      
      if (filteredData.length > 0) {
        updateChart(filteredData);
      }
    }
    
    function calculateStatistics(data) {
      const downloads = data.map(d => d.download).filter(v => !isNaN(v));
      const uploads = data.map(d => d.upload).filter(v => !isNaN(v));
      const pings = data.map(d => d.ping).filter(v => !isNaN(v));
      
      const stats = {
        download: {
          mean: downloads.reduce((a, b) => a + b, 0) / downloads.length,
          std: Math.sqrt(downloads.reduce((sq, n) => sq + Math.pow(n - downloads.reduce((a, b) => a + b, 0) / downloads.length, 2), 0) / downloads.length),
          min: Math.min(...downloads),
          max: Math.max(...downloads),
          median: downloads.sort((a, b) => a - b)[Math.floor(downloads.length / 2)]
        },
        upload: {
          mean: uploads.reduce((a, b) => a + b, 0) / uploads.length,
          std: Math.sqrt(uploads.reduce((sq, n) => sq + Math.pow(n - uploads.reduce((a, b) => a + b, 0) / uploads.length, 2), 0) / uploads.length),
          min: Math.min(...uploads),
          max: Math.max(...uploads),
          median: uploads.sort((a, b) => a - b)[Math.floor(uploads.length / 2)]
        },
        ping: {
          mean: pings.reduce((a, b) => a + b, 0) / pings.length,
          std: Math.sqrt(pings.reduce((sq, n) => sq + Math.pow(n - pings.reduce((a, b) => a + b, 0) / pings.length, 2), 0) / pings.length),
          min: Math.min(...pings),
          max: Math.max(...pings),
          median: pings.sort((a, b) => a - b)[Math.floor(pings.length / 2)]
        }
      };
      
      return stats;
    }
    
    function detectAnomaly(dataPoint) {
      const stats = calculateStatistics(filteredData);
      
      const downloadZ = Math.abs((dataPoint.download - stats.download.mean) / stats.download.std);
      const uploadZ = Math.abs((dataPoint.upload - stats.upload.mean) / stats.upload.std);
      const pingZ = Math.abs((dataPoint.ping - stats.ping.mean) / stats.ping.std);
      
      // Mark as anomaly if any metric is more than 2 standard deviations from mean
      return downloadZ > 2 || uploadZ > 2 || pingZ > 2;
    }
    
    function generateStatisticalOverlays(data) {
      const stats = calculateStatistics(data);
      const overlays = [];
      
      if (statisticalOverlays.showStdDev) {
        // Add standard deviation bands
        overlays.push({
          label: 'Download ±1σ',
          data: data.map(d => ({
            x: new Date(d.timestamp),
            y: stats.download.mean + stats.download.std
          })),
          borderColor: 'rgba(59, 130, 246, 0.3)',
          backgroundColor: 'rgba(59, 130, 246, 0.1)',
          borderDash: [5, 5],
          fill: false,
          pointRadius: 0
        });
        
        overlays.push({
          label: 'Download -1σ',
          data: data.map(d => ({
            x: new Date(d.timestamp),
            y: stats.download.mean - stats.download.std
          })),
          borderColor: 'rgba(59, 130, 246, 0.3)',
          backgroundColor: 'rgba(59, 130, 246, 0.1)',
          borderDash: [5, 5],
          fill: false,
          pointRadius: 0
        });
      }
      
      if (statisticalOverlays.showConfidence) {
        // Add 95% confidence intervals
        const confidenceLevel = 1.96; // 95% confidence
        overlays.push({
          label: 'Download 95% CI',
          data: data.map(d => ({
            x: new Date(d.timestamp),
            y: stats.download.mean + (confidenceLevel * stats.download.std / Math.sqrt(data.length))
          })),
          borderColor: 'rgba(16, 185, 129, 0.4)',
          backgroundColor: 'rgba(16, 185, 129, 0.1)',
          borderDash: [3, 3],
          fill: false,
          pointRadius: 0
        });
      }
      
      return overlays;
    }
    
    function compareWithHistorical(data) {
      const now = new Date();
      const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
      const oneMonthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
      
      const currentWeek = data.filter(d => new Date(d.timestamp) >= oneWeekAgo);
      const previousWeek = data.filter(d => {
        const date = new Date(d.timestamp);
        return date >= oneMonthAgo && date < oneWeekAgo;
      });
      
      const currentStats = calculateStatistics(currentWeek);
      const previousStats = calculateStatistics(previousWeek);
      
      const comparison = {
        download: {
          change: ((currentStats.download.mean - previousStats.download.mean) / previousStats.download.mean) * 100,
          trend: currentStats.download.mean > previousStats.download.mean ? 'up' : 'down'
        },
        upload: {
          change: ((currentStats.upload.mean - previousStats.upload.mean) / previousStats.upload.mean) * 100,
          trend: currentStats.upload.mean > previousStats.upload.mean ? 'up' : 'down'
        },
        ping: {
          change: ((currentStats.ping.mean - previousStats.ping.mean) / previousStats.ping.mean) * 100,
          trend: currentStats.ping.mean < previousStats.ping.mean ? 'up' : 'down'
        }
      };
      
      return comparison;
    }
    
    function exportChartPNG() {
      if (chart) {
        const canvas = chart.canvas;
        const link = document.createElement('a');
        link.download = `speedtest-chart-${new Date().toISOString().split('T')[0]}.png`;
        link.href = canvas.toDataURL();
        link.click();
        showMessage('Chart PNG exported successfully', 'success');
      }
    }
    
    function exportChartSVG() {
      if (chart) {
        const svg = chart.toBase64Image('image/svg+xml');
        const link = document.createElement('a');
        link.download = `speedtest-chart-${new Date().toISOString().split('T')[0]}.svg`;
        link.href = svg;
        link.click();
        showMessage('Chart SVG exported successfully', 'success');
      }
    }
    
    function toggleSection(sectionId) {
      const section = document.getElementById(sectionId);
      const toggle = section.querySelector('.section-toggle');
      
      if (section.classList.contains('section-hidden')) {
        section.classList.remove('section-hidden');
        toggle.textContent = '−';
      } else {
        section.classList.add('section-hidden');
        toggle.textContent = '+';
      }
    }
    
    function toggleDarkMode() {
      const body = document.body;
      const darkModeBtn = document.getElementById('darkModeToggle');
      const isDark = body.classList.contains('dark-mode');
      
      if (isDark) {
        body.classList.remove('dark-mode');
        localStorage.setItem('theme', 'light');
        if (darkModeBtn) {
          darkModeBtn.innerHTML = '🌙 Dark Mode';
        }
        showMessage('Switched to light mode', 'success');
      } else {
        body.classList.add('dark-mode');
        localStorage.setItem('theme', 'dark');
        if (darkModeBtn) {
          darkModeBtn.innerHTML = '☀️ Light Mode';
        }
        showMessage('Switched to dark mode', 'success');
      }
    }
    
    function toggleAutoUpdate() {
      if (autoRefreshTimer) {
        clearInterval(autoRefreshTimer);
        autoRefreshTimer = null;
        showMessage('Smart auto-update disabled', 'info');
      } else {
        startAutoRefresh();
        showMessage('Smart auto-update enabled (adaptive interval)', 'success');
      }
    }

    function hideSkeletonLoading() {
      const skeleton = document.getElementById('skeletonLoading');
      const summarySection = document.getElementById('summarySection');
      const chartSection = document.getElementById('chartSection');
      const tableSection = document.getElementById('tableSection');
      const ispComparisonSection = document.getElementById('ispComparisonSection');
      const healthScoreSection = document.getElementById('healthScoreSection');
      const alertsSection = document.getElementById('alertsSection');
      const quickActionsSection = document.getElementById('quickActionsSection');
      const timeAnalysisSection = document.getElementById('timeAnalysisSection');
      const exportOptionsSection = document.getElementById('exportOptionsSection');

      if (skeleton) { skeleton.style.display = 'none'; }
      if (summarySection) { summarySection.style.display = 'block'; }
      if (chartSection) { chartSection.style.display = 'block'; }
      if (tableSection) { tableSection.style.display = 'block'; }
      if (ispComparisonSection) { ispComparisonSection.style.display = 'block'; }
      if (healthScoreSection) { healthScoreSection.style.display = 'block'; }
      if (alertsSection) { alertsSection.style.display = 'block'; }
      if (quickActionsSection) { quickActionsSection.style.display = 'block'; }
      if (timeAnalysisSection) { timeAnalysisSection.style.display = 'block'; }
      if (exportOptionsSection) { exportOptionsSection.style.display = 'block'; }
    }

    function showSkeletonLoading() {
      const skeleton = document.getElementById('skeletonLoading');
      const summarySection = document.getElementById('summarySection');
      const chartSection = document.getElementById('chartSection');
      const tableSection = document.getElementById('tableSection');
      const ispComparisonSection = document.getElementById('ispComparisonSection');
      const healthScoreSection = document.getElementById('healthScoreSection');
      const alertsSection = document.getElementById('alertsSection');
      const quickActionsSection = document.getElementById('quickActionsSection');
      const timeAnalysisSection = document.getElementById('timeAnalysisSection');
      const exportOptionsSection = document.getElementById('exportOptionsSection');

      if (skeleton) { skeleton.style.display = 'block'; }
      if (summarySection) { summarySection.style.display = 'none'; }
      if (chartSection) { chartSection.style.display = 'none'; }
      if (tableSection) { tableSection.style.display = 'none'; }
      if (ispComparisonSection) { ispComparisonSection.style.display = 'none'; }
      if (healthScoreSection) { healthScoreSection.style.display = 'none'; }
      if (alertsSection) { alertsSection.style.display = 'none'; }
      if (quickActionsSection) { quickActionsSection.style.display = 'none'; }
      if (timeAnalysisSection) { timeAnalysisSection.style.display = 'none'; }
      if (exportOptionsSection) { exportOptionsSection.style.display = 'none'; }
    }

    // Initialize everything
    document.addEventListener('DOMContentLoaded', function() {
      // Load dark mode preference
      const darkMode = localStorage.getItem('theme') === 'dark';
      const darkModeBtn = document.getElementById('darkModeToggle');
      
      if (darkMode) {
        document.body.classList.add('dark-mode');
        if (darkModeBtn) {
          darkModeBtn.innerHTML = '☀️ Light Mode';
        }
      } else {
        document.body.classList.remove('dark-mode');
        if (darkModeBtn) {
          darkModeBtn.innerHTML = '🌙 Dark Mode';
        }
      }
      
      // Add window resize handler for responsive chart updates
      let resizeTimeout;
      window.addEventListener('resize', function() {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(function() {
          if (chart) {
            chart.resize();
          }
        }, 250);
      });
      
      // Hide content sections initially, show skeleton
      showSkeletonLoading();
      
      // Add event listeners for new features
      document.getElementById('darkModeToggle').addEventListener('click', toggleDarkMode);
      document.getElementById('autoUpdateBtn').addEventListener('click', toggleAutoUpdate);
      
      // Add keyboard shortcuts
      document.addEventListener('keydown', function(e) {
        if (e.ctrlKey || e.metaKey) {
          switch(e.key) {
            case 'r':
              e.preventDefault();
              loadData();
              break;
            case 'd':
              e.preventDefault();
              toggleDarkMode();
              break;
            case 'a':
              e.preventDefault();
              toggleAutoUpdate();
              break;
            case 'h':
              e.preventDefault();
              document.getElementById('keyboardShortcuts').classList.toggle('show');
              break;
          }
        }
      });
      
      // Add table sorting
      document.querySelectorAll('th.sortable').forEach(th => {
        th.addEventListener('click', function() {
          const column = this.dataset.sort;
          if (tableSortColumn === column) {
            tableSortDirection = tableSortDirection === 'asc' ? 'desc' : 'asc';
          } else {
            tableSortColumn = column;
            tableSortDirection = 'asc';
          }
          
          // Update visual indicators
          document.querySelectorAll('th').forEach(header => {
            header.classList.remove('sort-asc', 'sort-desc');
          });
          this.classList.add(tableSortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
          
          // Re-sort table
          if (filteredData.length > 0) {
            updateTable(filteredData);
          }
        });
      });
      
      // Initialize date picker
      flatpickr("#dateRange", {
        mode: "range",
        dateFormat: "Y-m-d",
        onChange: function(selectedDates) {
          if (selectedDates.length === 2) {
            minDate = selectedDates[0];
            maxDate = selectedDates[1];
            filterByDateRange();
          }
        }
      });
      
      // Initialize test status indicator
      updateTestStatus();
      
      // Load initial data
      loadData();
      
      // Start smart auto-refresh
      startAutoRefresh();
      document.getElementById('autoUpdateBtn').textContent = '⏸️ Stop Auto-Update';
    });

    function calculateISPComparison(data) {
      if (!data || data.length === 0) return null;
      
      const stats = calculateStatistics(data);
      const yourPerformance = {
        download: stats.download.mean,
        upload: stats.upload.mean,
        ping: stats.ping.mean
      };
      
      // Calculate percentile rankings
      const downloadPercentile = calculatePercentile(yourPerformance.download, 'download');
      const uploadPercentile = calculatePercentile(yourPerformance.upload, 'upload');
      const pingPercentile = calculatePercentile(yourPerformance.ping, 'ping', true); // Lower is better for ping
      
      // Overall performance score (0-100)
      const overallScore = Math.round((downloadPercentile + uploadPercentile + pingPercentile) / 3);
      
      return {
        yourPerformance,
        percentiles: {
          download: downloadPercentile,
          upload: uploadPercentile,
          ping: pingPercentile
        },
        overallScore,
        ranking: getPerformanceRanking(overallScore),
        comparisons: {
          global: compareWithBenchmark(yourPerformance, ispBenchmarks.global),
          fiber: compareWithBenchmark(yourPerformance, ispBenchmarks.fiber),
          cable: compareWithBenchmark(yourPerformance, ispBenchmarks.cable)
        }
      };
    }
    
    function calculatePercentile(value, metric, lowerIsBetter = false) {
      const benchmark = ispBenchmarks.global[metric];
      const fiberBenchmark = ispBenchmarks.fiber[metric];
      
      if (lowerIsBetter) {
        // For ping, lower values are better
        const ratio = benchmark / value;
        return Math.min(100, Math.max(0, ratio * 100));
      } else {
        // For download/upload, higher values are better
        const ratio = value / benchmark;
        return Math.min(100, Math.max(0, ratio * 100));
      }
    }
    
    function getPerformanceRanking(score) {
      if (score >= 90) return { level: 'excellent', label: 'Top 10%', class: 'ranking-excellent' };
      if (score >= 75) return { level: 'good', label: 'Top 25%', class: 'ranking-good' };
      if (score >= 50) return { level: 'average', label: 'Average', class: 'ranking-average' };
      return { level: 'poor', label: 'Below Average', class: 'ranking-poor' };
    }
    
    function compareWithBenchmark(yourPerformance, benchmark) {
      return {
        download: {
          value: yourPerformance.download,
          benchmark: benchmark.download,
          difference: yourPerformance.download - benchmark.download,
          percentage: ((yourPerformance.download - benchmark.download) / benchmark.download * 100).toFixed(1)
        },
        upload: {
          value: yourPerformance.upload,
          benchmark: benchmark.upload,
          difference: yourPerformance.upload - benchmark.upload,
          percentage: ((yourPerformance.upload - benchmark.upload) / benchmark.upload * 100).toFixed(1)
        },
        ping: {
          value: yourPerformance.ping,
          benchmark: benchmark.ping,
          difference: benchmark.ping - yourPerformance.ping, // Lower ping is better
          percentage: ((benchmark.ping - yourPerformance.ping) / benchmark.ping * 100).toFixed(1)
        }
      };
    }
    
    function updateISPComparison(data) {
      const comparison = calculateISPComparison(data);
      if (!comparison) return;
      
      const cardsContainer = document.getElementById('ispComparisonCards');
      const benchmarkContainer = document.getElementById('benchmarkGrid');
      
      // Create comparison cards
      cardsContainer.innerHTML = `
        <div class="comparison-card">
          <h3>Your Performance</h3>
          <div class="comparison-metric">
            <span class="metric-label">Download Speed</span>
            <div>
              <span class="metric-value">${comparison.yourPerformance.download.toFixed(1)} Mbps</span>
              <span class="metric-comparison">(${comparison.comparisons.global.download.percentage}% vs global)</span>
            </div>
          </div>
          <div class="comparison-metric">
            <span class="metric-label">Upload Speed</span>
            <div>
              <span class="metric-value">${comparison.yourPerformance.upload.toFixed(1)} Mbps</span>
              <span class="metric-comparison">(${comparison.comparisons.global.upload.percentage}% vs global)</span>
            </div>
          </div>
          <div class="comparison-metric">
            <span class="metric-label">Ping Latency</span>
            <div>
              <span class="metric-value">${comparison.yourPerformance.ping.toFixed(1)} ms</span>
              <span class="metric-comparison">(${comparison.comparisons.global.ping.percentage}% vs global)</span>
            </div>
          </div>
          <div class="ranking-badge ${comparison.ranking.class}">
            ${comparison.ranking.label} (${comparison.overallScore}/100)
          </div>
        </div>
        
        <div class="comparison-card">
          <h3>Global Average</h3>
          <div class="comparison-metric">
            <span class="metric-label">Download Speed</span>
            <span class="metric-value">${ispBenchmarks.global.download} Mbps</span>
          </div>
          <div class="comparison-metric">
            <span class="metric-label">Upload Speed</span>
            <span class="metric-value">${ispBenchmarks.global.upload} Mbps</span>
          </div>
          <div class="comparison-metric">
            <span class="metric-label">Ping Latency</span>
            <span class="metric-value">${ispBenchmarks.global.ping} ms</span>
          </div>
          <div class="performance-indicator">
            <span class="indicator-icon">📊</span>
            <span>Industry Baseline</span>
          </div>
        </div>
        
        <div class="comparison-card">
          <h3>Fiber Optic Benchmark</h3>
          <div class="comparison-metric">
            <span class="metric-label">Download Speed</span>
            <span class="metric-value">${ispBenchmarks.fiber.download} Mbps</span>
          </div>
          <div class="comparison-metric">
            <span class="metric-label">Upload Speed</span>
            <span class="metric-value">${ispBenchmarks.fiber.upload} Mbps</span>
          </div>
          <div class="comparison-metric">
            <span class="metric-label">Ping Latency</span>
            <span class="metric-value">${ispBenchmarks.fiber.ping} ms</span>
          </div>
          <div class="performance-indicator">
            <span class="indicator-icon">🚀</span>
            <span>Premium Performance</span>
          </div>
        </div>
      `;
      
      // Create benchmark grid
      benchmarkContainer.innerHTML = `
        <div class="benchmark-item">
          <span class="benchmark-label">Global Average</span>
          <span class="benchmark-value">${ispBenchmarks.global.download} Mbps</span>
        </div>
        <div class="benchmark-item">
          <span class="benchmark-label">Fiber Optic</span>
          <span class="benchmark-value">${ispBenchmarks.fiber.download} Mbps</span>
        </div>
        <div class="benchmark-item">
          <span class="benchmark-label">Cable Internet</span>
          <span class="benchmark-value">${ispBenchmarks.cable.download} Mbps</span>
        </div>
        <div class="benchmark-item">
          <span class="benchmark-label">DSL</span>
          <span class="benchmark-value">${ispBenchmarks.dsl.download} Mbps</span>
        </div>
        <div class="benchmark-item">
          <span class="benchmark-label">Mobile 5G</span>
          <span class="benchmark-value">${ispBenchmarks.mobile.download} Mbps</span>
        </div>
        <div class="benchmark-item">
          <span class="benchmark-label">Your Performance</span>
          <span class="benchmark-value">${comparison.yourPerformance.download.toFixed(1)} Mbps</span>
        </div>
      `;
    }
    
    // Performance Health Score Functions
    function calculateHealthScore(data) {
      if (!data || data.length === 0) return null;
      
      const stats = calculateStatistics(data);
      const recentTrend = calculateTrend(data.slice(-10));
      const consistency = calculateConsistency(data);
      const stability = calculateStability(data);
      
      // Calculate individual scores (0-100)
      const downloadScore = Math.min(100, (stats.download.mean / 1000) * 100);
      const uploadScore = Math.min(100, (stats.upload.mean / 100) * 100);
      const pingScore = Math.max(0, 100 - (stats.ping.mean / 2));
      const consistencyScore = consistency * 100;
      const stabilityScore = stability * 100;
      
      // Weighted overall score
      const overallScore = Math.round(
        (downloadScore * 0.3) +
        (uploadScore * 0.2) +
        (pingScore * 0.2) +
        (consistencyScore * 0.15) +
        (stabilityScore * 0.15)
      );
      
      return {
        score: overallScore,
        status: getHealthStatus(overallScore),
        trend: recentTrend.direction,
        metrics: {
          download: downloadScore,
          upload: uploadScore,
          ping: pingScore,
          consistency: consistencyScore,
          stability: stabilityScore
        },
        recommendations: generateRecommendations(stats, recentTrend, consistency, stability)
      };
    }
    
    function calculateTrend(data) {
      if (data.length < 2) return { direction: 'stable', score: 50 };
      
      const recent = data.slice(-5);
      const older = data.slice(-10, -5);
      
      if (recent.length === 0 || older.length === 0) return { direction: 'stable', score: 50 };
      
      const recentAvg = recent.reduce((sum, d) => sum + d.download, 0) / recent.length;
      const olderAvg = older.reduce((sum, d) => sum + d.download, 0) / older.length;
      
      const change = ((recentAvg - olderAvg) / olderAvg) * 100;
      
      if (change > 5) return { direction: 'up', score: 75 };
      if (change < -5) return { direction: 'down', score: 25 };
      return { direction: 'stable', score: 50 };
    }
    
    function calculateConsistency(data) {
      if (data.length < 2) return 0;
      
      const downloads = data.map(d => d.download);
      const mean = downloads.reduce((sum, d) => sum + d, 0) / downloads.length;
      const variance = downloads.reduce((sum, d) => sum + Math.pow(d - mean, 2), 0) / downloads.length;
      const stdDev = Math.sqrt(variance);
      
      // Higher consistency = lower standard deviation relative to mean
      return Math.max(0, 1 - (stdDev / mean));
    }
    
    function calculateStability(data) {
      if (data.length < 2) return 0;
      
      let stableCount = 0;
      for (let i = 1; i < data.length; i++) {
        const change = Math.abs(data[i].download - data[i-1].download) / data[i-1].download;
        if (change < 0.1) stableCount++; // Less than 10% change
      }
      
      return stableCount / (data.length - 1);
    }
    
    function getHealthStatus(score) {
      if (score >= 90) return { level: 'excellent', label: 'Excellent', class: 'health-score-excellent' };
      if (score >= 75) return { level: 'good', label: 'Good', class: 'health-score-good' };
      if (score >= 50) return { level: 'average', label: 'Average', class: 'health-score-average' };
      return { level: 'poor', label: 'Poor', class: 'health-score-poor' };
    }
    
    function generateRecommendations(stats, trend, consistency, stability) {
      const recommendations = [];
      
      if (stats.download.mean < 500) {
        recommendations.push('Consider upgrading your internet plan for better download speeds');
      }
      
      if (stats.upload.mean < 50) {
        recommendations.push('Upload speeds may be limiting for video calls and file sharing');
      }
      
      if (stats.ping.mean > 20) {
        recommendations.push('High latency detected - check for network congestion or ISP issues');
      }
      
      if (consistency < 0.7) {
        recommendations.push('Inconsistent performance detected - monitor for network issues');
      }
      
      if (stability < 0.8) {
        recommendations.push('Unstable connection detected - consider troubleshooting network');
      }
      
      if (trend.direction === 'down') {
        recommendations.push('Performance trending downward - contact your ISP');
      }
      
      return recommendations.length > 0 ? recommendations : ['Network performance is excellent!'];
    }
    
    function updateHealthScore(data) {
      healthScore = calculateHealthScore(data);
      if (!healthScore) return;
      
      const container = document.getElementById('healthScoreContainer');
      container.innerHTML = `
        <div class="health-score-header">
          <div class="health-score-title">Network Health Assessment</div>
          <div class="health-score-status">${healthScore.status.label}</div>
        </div>
        
        <div class="health-score-value ${healthScore.status.class}">
          ${healthScore.score}/100
        </div>
        
        <div class="health-score-trend">
          <span class="trend-${healthScore.trend}">
            ${healthScore.trend === 'up' ? '↗️' : healthScore.trend === 'down' ? '↘️' : '→'}
          </span>
          <span>Performance ${healthScore.trend === 'up' ? 'improving' : healthScore.trend === 'down' ? 'declining' : 'stable'}</span>
        </div>
        
        <div class="health-metrics">
          <div class="health-metric">
            <div class="health-metric-label">Download</div>
            <div class="health-metric-value">${Math.round(healthScore.metrics.download)}%</div>
          </div>
          <div class="health-metric">
            <div class="health-metric-label">Upload</div>
            <div class="health-metric-value">${Math.round(healthScore.metrics.upload)}%</div>
          </div>
          <div class="health-metric">
            <div class="health-metric-label">Latency</div>
            <div class="health-metric-value">${Math.round(healthScore.metrics.ping)}%</div>
          </div>
          <div class="health-metric">
            <div class="health-metric-label">Consistency</div>
            <div class="health-metric-value">${Math.round(healthScore.metrics.consistency)}%</div>
          </div>
          <div class="health-metric">
            <div class="health-metric-label">Stability</div>
            <div class="health-metric-value">${Math.round(healthScore.metrics.stability)}%</div>
          </div>
        </div>
        
        <div style="margin-top: 1rem; padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 8px; border: 1px solid var(--border);">
          <div style="font-weight: 600; color: var(--primary); margin-bottom: 0.5rem;">Recommendations:</div>
          <ul style="margin: 0; padding-left: 1.5rem; color: var(--text);">
            ${healthScore.recommendations.map(rec => `<li>${rec}</li>`).join('')}
          </ul>
        </div>
      `;
    }
    
    // Smart Alerts Functions
    function checkAlerts(data) {
      if (!data || data.length === 0) return;
      
      const latest = data[data.length - 1];
      const newAlerts = [];
      
      // Check download speed
      if (latest.download < alertThresholds.download.critical) {
        newAlerts.push({
          type: 'critical',
          title: 'Critical Download Speed Alert',
          message: `Download speed (${latest.download.toFixed(1)} Mbps) is critically low`,
          time: new Date().toLocaleString(),
          metric: 'download',
          value: latest.download
        });
      } else if (latest.download < alertThresholds.download.warning) {
        newAlerts.push({
          type: 'warning',
          title: 'Download Speed Warning',
          message: `Download speed (${latest.download.toFixed(1)} Mbps) is below optimal levels`,
          time: new Date().toLocaleString(),
          metric: 'download',
          value: latest.download
        });
      }
      
      // Check upload speed
      if (latest.upload < alertThresholds.upload.critical) {
        newAlerts.push({
          type: 'critical',
          title: 'Critical Upload Speed Alert',
          message: `Upload speed (${latest.upload.toFixed(1)} Mbps) is critically low`,
          time: new Date().toLocaleString(),
          metric: 'upload',
          value: latest.upload
        });
      } else if (latest.upload < alertThresholds.upload.warning) {
        newAlerts.push({
          type: 'warning',
          title: 'Upload Speed Warning',
          message: `Upload speed (${latest.upload.toFixed(1)} Mbps) is below optimal levels`,
          time: new Date().toLocaleString(),
          metric: 'upload',
          value: latest.upload
        });
      }
      
      // Check ping
      if (latest.ping > alertThresholds.ping.critical) {
        newAlerts.push({
          type: 'critical',
          title: 'Critical Latency Alert',
          message: `Ping latency (${latest.ping.toFixed(1)} ms) is critically high`,
          time: new Date().toLocaleString(),
          metric: 'ping',
          value: latest.ping
        });
      } else if (latest.ping > alertThresholds.ping.warning) {
        newAlerts.push({
          type: 'warning',
          title: 'Latency Warning',
          message: `Ping latency (${latest.ping.toFixed(1)} ms) is above optimal levels`,
          time: new Date().toLocaleString(),
          metric: 'ping',
          value: latest.ping
        });
      }
      
      // Add new alerts
      alerts = [...newAlerts, ...alerts].slice(0, 10); // Keep last 10 alerts
      updateAlerts();
    }
    
    function updateAlerts() {
      const container = document.getElementById('alertsContainer');
      
      if (alerts.length === 0) {
        container.innerHTML = `
          <div class="alert-card alert-info">
            <div class="alert-header">
              <div class="alert-title">No Active Alerts</div>
              <div class="alert-time">${new Date().toLocaleString()}</div>
            </div>
            <div class="alert-message">All performance metrics are within normal ranges.</div>
          </div>
        `;
        return;
      }
      
      container.innerHTML = alerts.map(alert => `
        <div class="alert-card alert-${alert.type}">
          <div class="alert-header">
            <div class="alert-title">${alert.title}</div>
            <div class="alert-time">${alert.time}</div>
          </div>
          <div class="alert-message">${alert.message}</div>
          <div class="alert-actions">
            <button class="alert-btn" onclick="dismissAlert('${alert.time}')">Dismiss</button>
            <button class="alert-btn" onclick="runTestNow()">Run Test</button>
          </div>
        </div>
      `).join('');
    }
    
    function dismissAlert(time) {
      alerts = alerts.filter(alert => alert.time !== time);
      updateAlerts();
    }
    
    // Quick Actions Functions
    function updateQuickActions() {
      const container = document.getElementById('quickActions');
      container.innerHTML = `
        <div class="quick-action-btn" onclick="runTestNow()">
          <span class="quick-action-icon">⚡</span>
          <div class="quick-action-label">Run Test</div>
        </div>
        <div class="quick-action-btn" onclick="filterLastHour()">
          <span class="quick-action-icon">🕐</span>
          <div class="quick-action-label">Last Hour</div>
        </div>
        <div class="quick-action-btn" onclick="filterLastDay()">
          <span class="quick-action-icon">📅</span>
          <div class="quick-action-label">Last Day</div>
        </div>
        <div class="quick-action-btn" onclick="filterLastWeek()">
          <span class="quick-action-icon">��</span>
          <div class="quick-action-label">Last Week</div>
        </div>
        <div class="quick-action-btn" onclick="exportCSV()">
          <span class="quick-action-icon">📄</span>
          <div class="quick-action-label">Export CSV</div>
        </div>
        <div class="quick-action-btn" onclick="shareSummary()">
          <span class="quick-action-icon">📤</span>
          <div class="quick-action-label">Share</div>
        </div>
        <div class="quick-action-btn" onclick="toggleDarkMode()">
          <span class="quick-action-icon">🌙</span>
          <div class="quick-action-label">Dark Mode</div>
        </div>
        <div class="quick-action-btn" onclick="toggleAutoUpdate()">
          <span class="quick-action-icon">🔄</span>
          <div class="quick-action-label">Auto Update</div>
        </div>
      `;
    }
    
    function filterLastHour() {
      const oneHourAgo = new Date(Date.now() - 60 * 60 * 1000);
      filteredData = allData.filter(d => new Date(d.timestamp) >= oneHourAgo);
      updateAll();
      showMessage('Filtered to last hour', 'success');
    }
    
    function filterLastDay() {
      const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
      filteredData = allData.filter(d => new Date(d.timestamp) >= oneDayAgo);
      updateAll();
      showMessage('Filtered to last day', 'success');
    }
    
    function filterLastWeek() {
      const oneWeekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
      filteredData = allData.filter(d => new Date(d.timestamp) >= oneWeekAgo);
      updateAll();
      showMessage('Filtered to last week', 'success');
    }
    
    // Time-of-Day Analysis Functions
    function switchTimePeriod(period) {
      currentTimePeriod = period;
      
      // Update button states
      document.querySelectorAll('.time-period-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
      
      // Update heatmap
      updateTimeAnalysis(filteredData);
    }
    
    function updateTimeAnalysis(data) {
      if (!data || data.length === 0) return;
      
      const heatmapData = generateHeatmapData(data, currentTimePeriod);
      updateHeatmap(heatmapData);
    }
    
    function generateHeatmapData(data, period) {
      const heatmap = {};
      
      data.forEach(d => {
        const date = new Date(d.timestamp);
        let key;
        
        if (period === 'hour') {
          key = date.getHours();
        } else if (period === 'day') {
          key = date.getDay();
        } else if (period === 'week') {
          const weekStart = new Date(date);
          weekStart.setDate(date.getDate() - date.getDay());
          key = weekStart.toISOString().split('T')[0];
        }
        
        if (!heatmap[key]) {
          heatmap[key] = { downloads: [], uploads: [], pings: [] };
        }
        
        heatmap[key].downloads.push(d.download);
        heatmap[key].uploads.push(d.upload);
        heatmap[key].pings.push(d.ping);
      });
      
      return heatmap;
    }
    
    function updateHeatmap(heatmapData) {
      const container = document.getElementById('heatmapGrid');
      const maxItems = currentTimePeriod === 'hour' ? 24 : currentTimePeriod === 'day' ? 7 : 52;
      
      let html = '';
      for (let i = 0; i < maxItems; i++) {
        const data = heatmapData[i];
        let performance = 'empty';
        
        if (data && data.downloads.length > 0) {
          const avgDownload = data.downloads.reduce((sum, d) => sum + d, 0) / data.downloads.length;
          if (avgDownload >= 800) performance = 'excellent';
          else if (avgDownload >= 600) performance = 'good';
          else if (avgDownload >= 400) performance = 'average';
          else performance = 'poor';
        }
        
        html += `<div class="heatmap-cell ${performance}" title="${getTimeLabel(i)}"></div>`;
      }
      
      container.innerHTML = html;
    }
    
    function getTimeLabel(index) {
      if (currentTimePeriod === 'hour') {
        return `${index}:00`;
      } else if (currentTimePeriod === 'day') {
        const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        return days[index];
      } else {
        return `Week ${index + 1}`;
      }
    }
    
    // Enhanced Export Functions
    function updateExportOptions() {
      const container = document.getElementById('exportOptions');
      container.innerHTML = `
        <div class="export-option" onclick="exportCSV()">
          <div class="export-option-icon">📄</div>
          <div class="export-option-title">CSV Export</div>
          <div class="export-option-desc">Raw data for analysis</div>
        </div>
        <div class="export-option" onclick="exportJSON()">
          <div class="export-option-icon">📊</div>
          <div class="export-option-title">JSON Export</div>
          <div class="export-option-desc">Structured data format</div>
        </div>
        <div class="export-option" onclick="exportChartPNG()">
          <div class="export-option-icon">📈</div>
          <div class="export-option-title">Chart PNG</div>
          <div class="export-option-desc">High-quality chart image</div>
        </div>
        <div class="export-option" onclick="exportChartSVG()">
          <div class="export-option-icon">🎨</div>
          <div class="export-option-title">Chart SVG</div>
          <div class="export-option-desc">Scalable vector format</div>
        </div>
        <div class="export-option" onclick="exportPDF()">
          <div class="export-option-icon">📋</div>
          <div class="export-option-title">PDF Report</div>
          <div class="export-option-desc">Complete dashboard report</div>
        </div>
        <div class="export-option" onclick="shareSummary()">
          <div class="export-option-icon">📤</div>
          <div class="export-option-title">Share Summary</div>
          <div class="export-option-desc">Quick performance summary</div>
        </div>
      `;
    }
    
    function exportPDF() {
      // Simple PDF generation using browser print
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <html>
          <head>
            <title>Speedtest Dashboard Report</title>
            <style>
              body { font-family: Arial, sans-serif; margin: 20px; }
              .header { text-align: center; margin-bottom: 30px; }
              .section { margin-bottom: 20px; }
              .metric { display: inline-block; margin: 10px; padding: 10px; border: 1px solid #ccc; }
            </style>
          </head>
          <body>
            <div class="header">
              <h1>Speedtest Dashboard Report</h1>
              <p>Generated on ${new Date().toLocaleString()}</p>
            </div>
            <div class="section">
              <h2>Performance Summary</h2>
              ${healthScore ? `
                <div class="metric">Health Score: ${healthScore.score}/100</div>
                <div class="metric">Status: ${healthScore.status.label}</div>
              ` : ''}
            </div>
            <div class="section">
              <h2>Recent Tests</h2>
              <p>Based on ${filteredData.length} speed tests</p>
            </div>
          </body>
        </html>
      `);
      printWindow.document.close();
      printWindow.print();
    }
    
    // Initialize the application
    document.addEventListener('DOMContentLoaded', function() {
      // Set up keyboard shortcuts and table sorting
      setupKeyboardShortcuts();
      setupTableSorting();
      
      // Initialize 3-day view mode
      chartViewMode = '3day';
      currentDayOffset = 0;
      
      // Set initial button states
      const threeDayBtn = document.getElementById('threeDayBtn');
      const allDataBtn = document.getElementById('allDataBtn');
      const navigation = document.getElementById('chartNavigation');
      
      if (threeDayBtn) threeDayBtn.classList.add('active');
      if (allDataBtn) allDataBtn.classList.remove('active');
      if (navigation) navigation.style.display = 'flex';
      
      // Initialize navigation state
      updateNavigationState();
      
      // Load initial data
      loadData();
      
      // Start auto-refresh
      startAutoRefresh();
    });
  </script>
  <div id="filterNotice" style="display:none;color:#c00;font-weight:bold;margin-top:1em;">Date range filter is active. Showing filtered results only. <button onclick="clearDateFilter()" class="export-btn" style="background:#c00;">Clear Filter</button></div>
</body>
</html> 